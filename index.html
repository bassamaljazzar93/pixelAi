<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المساعد الذكي الفوري | Real AI Assistant</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="المساعد الذكي">
    <link rel="manifest" href="/pixelAi/manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
            overflow-x: hidden;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 1.2rem;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 1rem;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Improved Realtime Chat Tab */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 400px;
            max-height: 500px;
        }

        .message {
            display: flex;
            gap: 10px;
            animation: slideIn 0.2s ease-out;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-bubble {
            max-width: 75%;
            padding: 15px 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            line-height: 1.5;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            border-radius: 20px 5px 20px 20px;
        }

        .message.ai .message-bubble {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 5px 20px 20px 20px;
        }

        .message.interim .message-bubble {
            background: rgba(255, 255, 255, 0.7);
            color: #666;
            font-style: italic;
        }

        .message.system .message-bubble {
            background: rgba(59, 130, 246, 0.8);
            color: white;
            font-size: 0.9rem;
            text-align: center;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
        }

        .user .avatar {
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
        }

        .ai .avatar {
            background: rgba(255, 255, 255, 0.9);
        }

        .system .avatar {
            background: rgba(59, 130, 246, 0.8);
        }

        /* Enhanced Realtime Status */
        .realtime-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
        }

        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .connection-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #EF4444;
            transition: all 0.3s ease;
        }

        .connection-dot.connected {
            background: #10B981;
            animation: pulse 2s infinite;
        }

        .connection-dot.connecting {
            background: #F59E0B;
            animation: spin 1s linear infinite;
        }

        /* Audio Controls */
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 0.9rem;
        }

        #volumeSlider {
            width: 80px;
            height: 5px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            -webkit-appearance: none;
        }

        #volumeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }

        #muteButton {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        #muteButton:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Enhanced Controls */
        .controls {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            position: sticky;
            bottom: 0;
        }

        .mic-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.3);
            font-size: 2rem;
        }

        .mic-button:not(.recording):not(.disabled) {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }

        .mic-button.recording {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            animation: recordingPulse 0.8s infinite;
        }

        .mic-button.disabled {
            background: linear-gradient(135deg, #6B7280, #4B5563);
            color: white;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .mic-button:active:not(.disabled) {
            transform: scale(0.95);
        }

        .session-controls {
            display: flex;
            gap: 10px;
        }

        .session-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            color: white;
        }

        .start-session-btn {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .end-session-btn {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }

        .session-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .session-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Everything else stays the same from the original */
        .prompt-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
            resize: vertical;
            min-height: 50px;
        }

        .prompt-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .generate-btn {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
            min-width: 150px;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .generated-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .image-card:hover {
            transform: scale(1.02);
        }

        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
        }

        .image-info {
            padding: 1rem;
            color: white;
            font-size: 0.9rem;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.1);
        }

        .upload-area.dragover {
            border-color: #4F46E5;
            background: rgba(79, 70, 229, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .upload-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }

        .analysis-result {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
            color: #333;
            text-align: right;
            line-height: 1.6;
        }

        .news-search {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .news-search input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
        }

        .news-search input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-btn {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .search-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .search-btn:disabled {
            opacity: 0.6;
        }

        .news-sources {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .source-btn {
            padding: 8px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
        }

        .source-btn.active {
            background: linear-gradient(135deg, #10B981, #059669);
            border-color: transparent;
        }

        .news-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .news-item {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            color: #333;
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 4px solid #4F46E5;
        }

        .news-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .news-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #1f2937;
            line-height: 1.4;
        }

        .news-summary {
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #9ca3af;
            align-items: center;
        }

        .news-source {
            background: #4F46E5;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .settings-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4F46E5;
            background: white;
        }

        .save-btn {
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }

        .empty-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            padding: 2rem;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .hidden {
            display: none !important;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            backdrop-filter: blur(10px);
            animation: slideIn 0.2s ease-out;
            max-width: 300px;
            word-wrap: break-word;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toast.success { background: linear-gradient(135deg, #10B981, #059669); }
        .toast.error { background: linear-gradient(135deg, #EF4444, #DC2626); }
        .toast.warning { background: linear-gradient(135deg, #F59E0B, #D97706); }
        .toast.info { background: linear-gradient(135deg, #3B82F6, #2563EB); }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.04); }
        }

        @keyframes recordingPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0.8rem;
            }
            
            .main-container {
                padding: 0.5rem;
            }
            
            .tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .tab {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .controls {
                padding: 1rem;
                gap: 1rem;
            }
            
            .mic-button {
                width: 70px;
                height: 70px;
                font-size: 1.5rem;
            }
            
            .session-controls {
                flex-direction: column;
                gap: 5px;
            }
            
            .session-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .realtime-status {
                flex-direction: column;
                gap: 10px;
            }
            
            .generated-images {
                grid-template-columns: 1fr;
            }

            .news-search {
                flex-direction: column;
            }

            .search-btn {
                width: 100%;
            }
        }

        .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .install-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
            display: none;
        }

        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>
<body>
    <!-- PWA Install Button -->
    <button class="install-btn" id="installBtn" onclick="installPWA()">📱 تثبيت التطبيق</button>

    <!-- Fullscreen Button -->
    <button class="fullscreen-btn" onclick="toggleFullscreen()">⛶</button>

    <!-- Header -->
    <div class="header">
        <div class="logo">🚀 المساعد الذكي الفوري</div>
        <div class="header-controls">
            <button class="header-btn" onclick="openSettings()" title="الإعدادات">⚙️</button>
            <button class="header-btn" onclick="closeApp()" title="إغلاق التطبيق">❌</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('chat')">🎤 محادثة فورية</div>
            <div class="tab" onclick="switchTab('images')">🎨 صور</div>
            <div class="tab" onclick="switchTab('analysis')">🔍 تحليل</div>
            <div class="tab" onclick="switchTab('news')">📰 أخبار</div>
        </div>

        <!-- Realtime Chat Tab -->
        <div class="tab-content active" id="chatTab">
            <div class="realtime-status">
                <div class="connection-indicator">
                    <div class="connection-dot" id="connectionDot"></div>
                    <span id="connectionStatus">غير متصل</span>
                </div>
                <div class="audio-controls">
                    <div class="volume-control">
                        <button id="muteButton">🔊</button>
                        <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1">
                        <span>صوت المساعد</span>
                    </div>
                    <button id="testAudioBtn" onclick="testAudio()" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-size: 0.9rem;">🔊 اختبار الصوت</button>
                </div>
            </div>
            
            <div class="messages" id="messages">
                <div class="empty-state">
                    <h3>🎤 المساعد الذكي الفوري</h3>
                    <p>ابدأ جلسة محادثة فورية مع GPT-4 Realtime API</p>
                    <small style="color: rgba(255,255,255,0.6); margin-top: 1rem; display: block;">
                        ⚡ WebRTC + Ephemeral Keys للأمان والسرعة
                    </small>
                </div>
            </div>
        </div>

        <!-- Image Generation Tab -->
        <div class="tab-content" id="imagesTab">
            <div class="image-generator">
                <h3 style="color: white; margin-bottom: 1rem; text-align: center;">🎨 مولد الصور السريع</h3>
                <textarea class="prompt-input" id="imagePrompt" placeholder="اكتب وصف الصورة... مثال: قطة جميلة في حديقة، نمط كرتوني ملون" rows="3"></textarea>
                <div style="text-align: center;">
                    <button class="generate-btn" onclick="generateImage()">
                        <span id="generateBtnText">🎨 توليد الصورة</span>
                    </button>
                </div>
                <div class="generated-images" id="generatedImages"></div>
            </div>
        </div>

        <!-- Image Analysis Tab -->
        <div class="tab-content" id="analysisTab">
            <div class="image-analysis">
                <h3 style="color: white; margin-bottom: 1rem; text-align: center;">🔍 تحليل الصور السريع</h3>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">📸</div>
                    <div class="upload-text">اضغط هنا أو اسحب صورة لتحليلها فوراً</div>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="analyzeImage(this.files[0])">
                <div id="analysisResults"></div>
            </div>
        </div>

        <!-- RSS News Tab -->
        <div class="tab-content" id="newsTab">
            <div class="news-section">
                <h3 style="color: white; margin-bottom: 1rem; text-align: center;">📰 أخبار محدثة - 3 يوليو 2025</h3>
                <p style="color: rgba(255,255,255,0.8); font-size: 0.9rem; text-align: center; margin-bottom: 1rem;">
                    🔄 يستخدم RSS2JSON + CORS Proxy + محتوى مجاني
                </p>
                
                <!-- Search News -->
                <div class="news-search">
                    <input type="text" id="newsQuery" placeholder="ابحث في الأخبار... مثال: تكنولوجيا، رياضة، سياسة">
                    <button class="search-btn" onclick="searchNews()">
                        <span id="searchBtnText">🔍 بحث</span>
                    </button>
                </div>

                <!-- News Sources -->
                <div class="news-sources">
                    <div class="source-btn active" onclick="loadNews('all')">🌍 جميع المصادر</div>
                    <div class="source-btn" onclick="loadNews('bbc')">📺 BBC</div>
                    <div class="source-btn" onclick="loadNews('cnn')">📡 CNN</div>
                    <div class="source-btn" onclick="loadNews('tech')">💻 تقنية</div>
                    <div class="source-btn" onclick="loadNews('sports')">⚽ رياضة</div>
                    <div class="source-btn" onclick="loadNews('science')">🧬 علوم</div>
                </div>
                
                <div class="news-container" id="newsContainer">
                    <div class="empty-state">
                        <h3>📰 جاري تحميل الأخبار...</h3>
                        <p>سيتم تجربة طرق متعددة لجلب الأخبار</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Controls -->
    <div class="controls">
        <div class="session-controls">
            <button class="session-btn start-session-btn" id="startButton" onclick="startSession()">🟢 بدء جلسة</button>
            <button class="session-btn end-session-btn hidden" id="endButton" onclick="endSession()">🔴 إنهاء الجلسة</button>
        </div>
        <button class="mic-button disabled" id="micButton">🎤</button>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; color: #333;">
                <h2>⚙️ الإعدادات السريعة</h2>
                <button onclick="closeSettings()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="openaiApiKey">مفتاح OpenAI API (مطلوب للـ Realtime API):</label>
                <input type="password" id="openaiApiKey" placeholder="sk-..." value="Your OPENAI_API_KEY from platform.openai.com">
                <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                    ⚡ مطلوب للمحادثة الفورية وتوليد الصور وتحليلها
                </small>
            </div>
            
            <div class="form-group">
                <label for="model">نموذج المحادثة:</label>
                <select id="model">
                    <option value="gpt-4o-realtime-preview">GPT-4o Realtime (الأحدث)</option>
                    <option value="gpt-4o-mini-realtime-preview">GPT-4o Mini Realtime (سريع)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="imageModel">نموذج الصور:</label>
                <select id="imageModel">
                    <option value="dall-e-2">DALL-E 2 (سريع)</option>
                    <option value="dall-e-3">DALL-E 3 (جودة عالية)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="voice">الصوت:</label>
                <select id="voice">
                    <option value="alloy">Alloy (متوازن)</option>
                    <option value="echo">Echo (عميق)</option>
                    <option value="fable">Fable (بريطاني)</option>
                    <option value="onyx">Onyx (قوي)</option>
                    <option value="nova">Nova (دافئ)</option>
                    <option value="shimmer">Shimmer (ناعم)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="temperature">درجة الحرارة:</label>
                <input type="number" id="temperature" step="0.1" min="0" max="2" value="1.0" style="width: 100px;">
                <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                    من 0 (محافظ) إلى 2 (إبداعي)
                </small>
            </div>

            <div class="form-group">
                <label for="whisperLanguage">لغة الـ Whisper (التعرف على الكلام):</label>
                <select id="whisperLanguage">
                    <option value="ar">العربية (Arabic)</option>
                    <option value="en">الإنجليزية (English)</option>
                    <option value="auto">تلقائي (Auto-detect)</option>
                    <option value="es">الإسبانية (Spanish)</option>
                    <option value="fr">الفرنسية (French)</option>
                    <option value="de">الألمانية (German)</option>
                    <option value="it">الإيطالية (Italian)</option>
                    <option value="pt">البرتغالية (Portuguese)</option>
                    <option value="ru">الروسية (Russian)</option>
                    <option value="ja">اليابانية (Japanese)</option>
                    <option value="ko">الكورية (Korean)</option>
                    <option value="zh">الصينية (Chinese)</option>
                </select>
                <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                    🎤 لضمان دقة التعرف على الكلام
                </small>
            </div>

            <div class="form-group">
                <label for="responseLanguage">لغة الاستجابة:</label>
                <select id="responseLanguage">
                    <option value="arabic">العربية</option>
                    <option value="english">English</option>
                    <option value="mixed">مختلط (عربي/انجليزي)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="sessionInstructions">تعليمات الجلسة:</label>
                <textarea id="sessionInstructions" rows="3" style="resize: vertical;">أنت مساعد ذكي مفيد وودود. أجب باللغة العربية بشكل طبيعي ومختصر.</textarea>
            </div>
            
            <button class="save-btn" onclick="saveSettings()">💾 حفظ الإعدادات</button>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 10px; font-size: 0.9rem; color: #333;">
                <strong>🚀 التحسينات الجديدة:</strong><br>
                
                <div style="margin: 0.5rem 0;">
                    <strong>⚡ WebRTC محسن:</strong><br>
                    • Ephemeral Keys آمنة<br>
                    • Session Management متقدم<br>
                    • Audio Controls محسنة<br>
                    • Error Handling شامل
                </div>
                
                <div style="margin: 0.5rem 0;">
                    <strong>🎧 تحكم الصوت:</strong><br>
                    • Volume Control<br>
                    • Mute/Unmute<br>
                    • Audio Test Button<br>
                    • Auto-play للردود
                </div>
                
                <div style="margin: 0.5rem 0;">
                    <strong>🗣️ إعدادات اللغة:</strong><br>
                    • تحديد لغة Whisper للدقة<br>
                    • اختيار لغة الاستجابة<br>
                    • دعم متعدد اللغات<br>
                    • تحسين التعرف على الكلام
                </div>
                
                <div style="margin: 0.5rem 0;">
                    <strong>🔧 استكشاف الأخطاء:</strong><br>
                    • إذا لم يعمل الصوت، جرب زر "اختبار الصوت"<br>
                    • تأكد من تحديد اللغة الصحيحة<br>
                    • اضغط على الشاشة لتفعيل الصوت<br>
                    • تحقق من إعدادات المتصفح
                </div>
                
                <div style="margin: 0.5rem 0;">
                    <strong>🔑 احصل على المفتاح:</strong><br>
                    <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #4F46E5;">platform.openai.com/api-keys</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Remote Audio Element -->
    <audio id="remoteAudio" autoplay></audio>

    <script>
        // ========= Enhanced WebRTC Realtime Implementation =========
        // Global Variables from index.html
        let pc;                      // RTCPeerConnection
        let track;                   // Local audio track
        let dc;                      // Data channel
        const assistantResults = {}; // Track interim/final transcripts
        const userMessages = {};     // Track user messages per item ID

        // Enhanced Global Variables
        let apiKey = '';
        let selectedModel = 'gpt-4o-realtime-preview';
        let selectedVoice = 'alloy';
        let temperature = 1.0;
        let sessionInstructions = 'أنت مساعد ذكي مفيد وودود. أجب باللغة العربية بشكل طبيعي ومختصر.';
        let imageModel = 'dall-e-2';
        let whisperLanguage = 'ar';
        let responseLanguage = 'arabic';
        let isConnected = false;
        let currentTab = 'chat';
        let newsCache = new Map();
        let deferredPrompt = null;

        // Model & function definitions
        const model = selectedModel;
        const gptFunctions = [
            {
                type: "function",
                name: "end_session",
                description: "the user would like to stop interacting with the Agent",
                parameters: {},
            },
        ];

        // Default values
        const defaultSessionInstructions = "أنت مساعد ذكي مفيد وودود. أجب باللغة العربية بشكل طبيعي ومختصر.";
        const defaultTemperature = 1.0;
        const defaultVoice = "alloy";
        const defaultWhisperLanguage = "ar";
        const defaultResponseLanguage = "arabic";

        // ========= DOM Elements =========
        const startButtonEl = document.getElementById('startButton');
        const endButtonEl = document.getElementById('endButton');
        const micButtonEl = document.getElementById('micButton');
        const connectionDotEl = document.getElementById('connectionDot');
        const connectionStatusEl = document.getElementById('connectionStatus');
        const messagesEl = document.getElementById('messages');
        const remoteAudioEl = document.getElementById('remoteAudio');
        const muteButtonEl = document.getElementById('muteButton');
        const volumeSliderEl = document.getElementById('volumeSlider');

        // ========= Enhanced WebRTC Functions (from index.html) =========
        
        /**
         * Send initial session instructions and start message.
         */
        function sessionStartMessages() {
            const languageMap = {
                'arabic': 'أنت مساعد ذكي مفيد وودود. أجب باللغة العربية بشكل طبيعي ومختصر وواضح.',
                'english': 'You are a helpful and friendly AI assistant. Respond in English naturally and concisely.',
                'mixed': 'أنت مساعد ذكي مفيد وودود. يمكنك الرد بالعربية أو الإنجليزية حسب لغة السؤال.'
            };

            const finalInstructions = sessionInstructions + ' ' + (languageMap[responseLanguage] || languageMap['arabic']);
            const startInstruct = responseLanguage === 'english' ? 
                "Start the conversation with a friendly greeting in English." : 
                "ابدأ المحادثة بترحيب لطيف باللغة العربية.";

            // Update the session with language settings
            const systemMessage = {
                type: "session.update",
                session: {
                    instructions: finalInstructions,
                    voice: selectedVoice,
                    tools: gptFunctions,
                    tool_choice: "auto",
                    input_audio_transcription: {
                        model: "whisper-1",
                        language: whisperLanguage === 'auto' ? null : whisperLanguage
                    },
                    temperature: temperature,
                    modalities: ["text", "audio"],
                    turn_detection: {
                        type: "server_vad",
                        threshold: 0.5,
                        prefix_padding_ms: 300,
                        silence_duration_ms: 800
                    }
                }
            };
            dc.send(JSON.stringify(systemMessage));

            // Send initial greeting
            const startMessage = {
                type: "response.create",
                response: {
                    modalities: ["text", "audio"],
                    instructions: startInstruct,
                    max_output_tokens: 150
                }
            };
            dc.send(JSON.stringify(startMessage));
            appendOrUpdateLog("تم بدء الجلسة مع إعدادات اللغة المطلوبة.", "system");
        }

        /**
         * Handle incoming DataChannel messages from the GPT server.
         */
        function handleMessage(event) {
            const message = JSON.parse(event.data);
            const itemId = message.item_id;

            console.log('Received message:', message.type, message);

            switch (message.type) {
                case "session.created":
                    const expiresAt = new Date(message?.session?.expires_at * 1000);
                    console.log(`Session created and will expire at ${expiresAt}`, message);
                    toggleSessionButtons(true);
                    updateConnectionStatus('connected');
                    showToast('🔗 تم إنشاء الجلسة بنجاح!', 'success');
                    break;

                case "session.updated":
                    console.log('Session updated:', message.session);
                    showToast('⚙️ تم تحديث إعدادات الجلسة', 'info');
                    break;

                case "input_audio_buffer.speech_started":
                    userMessages[itemId] = {message: ""};
                    appendOrUpdateLog(`🎤 جاري الاستماع...`, "user", itemId);
                    break;

                case "input_audio_buffer.speech_stopped":
                    console.log('Speech stopped, processing...');
                    break;

                case "conversation.item.input_audio_transcription.completed":
                    const content = message.transcript;
                    if (content && userMessages[itemId]) {
                        userMessages[itemId].message = content;
                        appendOrUpdateLog(`${content}`, "user", itemId);
                        console.log('User transcription:', content);
                    }
                    break;

                case "response.audio_transcript.delta":
                    if (itemId) {
                        assistantResults[itemId] = assistantResults[itemId] || "";
                        assistantResults[itemId] += message.delta;
                        appendOrUpdateLog(`${assistantResults[itemId]}`, "interim", itemId);
                    }
                    break;

                case "response.audio_transcript.done":
                    if (itemId) {
                        assistantResults[itemId] = message.transcript;
                        appendOrUpdateLog(`${message.transcript}`, "ai", itemId);
                        console.log('AI response transcript:', message.transcript);
                    }
                    break;

                case "response.audio.delta":
                    // Audio is streamed through WebRTC automatically
                    console.log('Receiving audio delta...');
                    break;

                case "response.audio.done":
                    console.log('Audio response completed');
                    break;

                case "response.done":
                    console.log('Response completed');
                    break;

                case "response.function_call_arguments.done":
                    const {name} = message;
                    if (name === "end_session") {
                        console.log("Ending session based on user request");
                        endSession();
                    }
                    break;

                case "error":
                    console.error("Server error:", message.error);
                    showToast('❌ خطأ من الخادم: ' + message.error.message, 'error');
                    break;

                default:
                    console.info(`Unhandled message from server: ${message.type}`, message);
                    break;
            }
        }

        /**
         * Start a new WebRTC session with the OpenAI Realtime API.
         */
        async function startSession() {
            console.log("start_session");
            startButtonEl.disabled = true;
            
            if (!apiKey || apiKey === "Your OPENAI_API_KEY from platform.openai.com") {
                console.error("No OpenAI API Key provided");
                showToast('⚠️ أدخل مفتاح OpenAI API في الإعدادات', 'warning');
                openSettings();
                toggleSessionButtons(false);
                return;
            }

            updateConnectionStatus('connecting');
            showToast('🔗 جاري الاتصال بـ OpenAI Realtime API...', 'info');
            
            // Capture the local mic with high quality settings
            let stream;
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 24000,
                        channelCount: 1
                    }
                });
                if (!stream) {
                    throw new Error("Failed to get local stream");
                }
                [track] = stream.getAudioTracks();
                console.log('Microphone access granted:', track.getSettings());
            } catch (err) {
                console.error("Error accessing mic:", err);
                showToast('❌ فشل الوصول للميكروفون. تحقق من الأذونات.', 'error');
                toggleSessionButtons(false);
                updateConnectionStatus('error');
                return;
            }

            // Start the WebRTC session
            try {
                // Create PeerConnection with STUN servers
                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });

                // Enhanced audio setup
                pc.ontrack = (e) => {
                    console.log('Received remote track:', e.track.kind);
                    if (e.track.kind === 'audio') {
                        remoteAudioEl.srcObject = e.streams[0];
                        remoteAudioEl.autoplay = true;
                        remoteAudioEl.volume = volumeSliderEl.value;
                        
                        // Ensure audio plays
                        remoteAudioEl.play().then(() => {
                            console.log('Remote audio playing successfully');
                            showToast('🔊 تم تفعيل الصوت بنجاح', 'success');
                        }).catch(err => {
                            console.error('Audio play failed:', err);
                            showToast('⚠️ اضغط على الشاشة لتفعيل الصوت', 'warning');
                        });
                    }
                };
                
                // Add the local audio track
                pc.addTrack(track, stream);
                console.log('Added local audio track');

                // Create data channel
                dc = pc.createDataChannel("oai", {
                    ordered: true
                });

                // Send session instructions upon opening the data channel
                dc.addEventListener("open", () => {
                    console.log('Data channel opened');
                    sessionStartMessages();
                });

                // Handle incoming messages from the server
                dc.addEventListener("message", handleMessage);

                // Handle data channel errors
                dc.addEventListener("error", (err) => {
                    console.error('Data channel error:', err);
                    showToast('❌ خطأ في قناة البيانات', 'error');
                });

                // Handle connection state changes
                pc.addEventListener("connectionstatechange", () => {
                    console.log("Connection state:", pc.connectionState);
                    if (pc.connectionState === 'failed') {
                        updateConnectionStatus('error');
                        showToast('❌ فشل الاتصال', 'error');
                    } else if (pc.connectionState === 'disconnected') {
                        updateConnectionStatus('disconnected');
                        showToast('🔌 انقطع الاتصال', 'warning');
                    } else if (pc.connectionState === 'connected') {
                        console.log('WebRTC connected successfully!');
                    }
                });

                // Monitor ICE connection state
                pc.addEventListener("iceconnectionstatechange", () => {
                    console.log("ICE connection state:", pc.iceConnectionState);
                });

                // Create and set local description
                await pc.setLocalDescription();
                console.log('Local description set');

                // Send offer to OpenAI Realtime API
                const baseUrl = "https://api.openai.com/v1/realtime";
                const response = await fetch(`${baseUrl}?model=${selectedModel}`, {
                    method: "POST",
                    body: pc.localDescription.sdp,
                    headers: {
                        Authorization: `Bearer ${apiKey}`,
                        "Content-Type": "application/sdp"
                    },
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const answerSdp = await response.text();
                const answer = {type: "answer", sdp: answerSdp};
                await pc.setRemoteDescription(answer);
                console.log('Remote description set');

                // Wait for connection to be established
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error(`انتهت مهلة الاتصال. الحالة: ${pc.connectionState}`));
                    }, 15000);
                    
                    pc.addEventListener("connectionstatechange", () => {
                        if (pc.connectionState === "connected") {
                            clearTimeout(timeout);
                            console.log("WebRTC Peer connection established!");
                            isConnected = true;
                            resolve();
                        } else if (pc.connectionState === "failed") {
                            clearTimeout(timeout);
                            reject(new Error("فشل في إنشاء الاتصال"));
                        }
                    });
                });

                showToast('✅ تم الاتصال بنجاح! تحدث الآن', 'success');

            } catch (err) {
                console.error("Error starting session:", err);
                showToast('❌ خطأ في بدء الجلسة: ' + err.message, 'error');
                if (pc && pc.connectionState !== "closed") {
                    pc.close();
                }
                toggleSessionButtons(false);
                updateConnectionStatus('error');
            }
        }

        /**
         * End the current session.
         */
        async function endSession(instructions = "وداعاً! شكراً لاستخدام المساعد الذكي.") {
            console.log("Ending session...");

            if (dc?.readyState === "open") {
                // Send farewell message
                const message = {
                    type: "response.create",
                    response: {
                        modalities: ["text", "audio"],
                        instructions: instructions,
                        max_output_tokens: 50
                    }
                };
                dc.send(JSON.stringify(message));

                // Wait a bit for the farewell then close
                setTimeout(() => {
                    if (pc) {
                        pc.close();
                        console.log("Session ended.");
                        appendOrUpdateLog("تم إنهاء الجلسة.", "system");
                        isConnected = false;
                        toggleSessionButtons(false);
                        updateConnectionStatus('disconnected');
                    }
                }, 3000);
            } else {
                if (pc) {
                    pc.close();
                    isConnected = false;
                    toggleSessionButtons(false);
                    updateConnectionStatus('disconnected');
                }
            }

            // Turn off mic
            if (track && track.readyState !== "ended") {
                track.stop();
            }

            endButtonEl.disabled = true;
            showToast('👋 تم إنهاء الجلسة', 'info');
        }

        /**
         * Toggle the session control buttons based on the session state.
         */
        function toggleSessionButtons(isSessionActive) {
            startButtonEl.hidden = isSessionActive;
            endButtonEl.hidden = !isSessionActive;
            startButtonEl.disabled = isSessionActive;
            endButtonEl.disabled = false;
            
            // Update mic button with clearer instructions
            if (isSessionActive) {
                micButtonEl.className = 'mic-button';
                micButtonEl.innerHTML = '🎤';
                micButtonEl.title = 'متصل - ابدأ بالتحدث الآن';
                showToast('🎤 الميكروفون جاهز - ابدأ بالتحدث!', 'info');
            } else {
                micButtonEl.className = 'mic-button disabled';
                micButtonEl.innerHTML = '🔌';
                micButtonEl.title = 'اضغط "بدء جلسة" أولاً';
            }
        }

        /**
         * Update connection status indicator
         */
        function updateConnectionStatus(status) {
            switch (status) {
                case 'connecting':
                    connectionDotEl.className = 'connection-dot connecting';
                    connectionStatusEl.textContent = 'جاري الاتصال...';
                    break;
                case 'connected':
                    connectionDotEl.className = 'connection-dot connected';
                    connectionStatusEl.textContent = 'متصل - جاهز للمحادثة';
                    break;
                case 'disconnected':
                    connectionDotEl.className = 'connection-dot';
                    connectionStatusEl.textContent = 'غير متصل';
                    break;
                case 'error':
                    connectionDotEl.className = 'connection-dot';
                    connectionStatusEl.textContent = 'خطأ في الاتصال';
                    break;
            }
        }

        /**
         * Insert a new log entry or update an existing one.
         */
        function appendOrUpdateLog(message, type = "ai", messageId = null) {
            const emptyState = messagesEl.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            let messageElement;
            if (messageId && document.getElementById(messageId)) {
                messageElement = document.getElementById(messageId);
                messageElement.querySelector('.message-bubble').textContent = message;
            } else {
                messageElement = document.createElement("div");
                messageElement.className = `message ${type}`;
                if (messageId) messageElement.id = messageId;

                const avatar = type === 'user' ? '👤' : type === 'ai' ? '🤖' : type === 'system' ? 'ℹ️' : '⚡';
                
                messageElement.innerHTML = `
                    <div class="avatar">${avatar}</div>
                    <div class="message-bubble">${message}</div>
                `;
                
                messagesEl.appendChild(messageElement);
            }
            
            messagesEl.scrollTop = messagesEl.scrollHeight;
            
            // Keep only last 50 messages
            while (messagesEl.children.length > 50) {
                messagesEl.removeChild(messagesEl.firstChild);
            }
        }

        // ========= Audio Controls =========
        
        // Volume controls
        volumeSliderEl.addEventListener('input', (e) => {
            remoteAudioEl.volume = e.target.value;
        });

        // Mute button
        let isMuted = false;
        muteButtonEl.addEventListener('click', () => {
            isMuted = !isMuted;
            remoteAudioEl.muted = isMuted;
            muteButtonEl.textContent = isMuted ? '🔇' : '🔊';
        });

        // ========= Settings Functions (Enhanced) =========
        
        function loadSettings() {
            // Load from localStorage with defaults
            apiKey = localStorage.getItem('openai_api_key') || 'Your OPENAI_API_KEY from platform.openai.com';
            selectedModel = localStorage.getItem('selected_model') || 'gpt-4o-realtime-preview';
            selectedVoice = localStorage.getItem('selected_voice') || 'alloy';
            temperature = parseFloat(localStorage.getItem('temperature')) || 1.0;
            sessionInstructions = localStorage.getItem('session_instructions') || defaultSessionInstructions;
            imageModel = localStorage.getItem('image_model') || 'dall-e-2';
            whisperLanguage = localStorage.getItem('whisper_language') || 'ar';
            responseLanguage = localStorage.getItem('response_language') || 'arabic';
        }

        function loadSettingsForm() {
            document.getElementById('openaiApiKey').value = apiKey;
            document.getElementById('model').value = selectedModel;
            document.getElementById('voice').value = selectedVoice;
            document.getElementById('temperature').value = temperature;
            document.getElementById('sessionInstructions').value = sessionInstructions;
            document.getElementById('imageModel').value = imageModel;
            document.getElementById('whisperLanguage').value = whisperLanguage;
            document.getElementById('responseLanguage').value = responseLanguage;
        }

        function saveSettings() {
            // Get values from form
            apiKey = document.getElementById('openaiApiKey').value;
            selectedModel = document.getElementById('model').value;
            selectedVoice = document.getElementById('voice').value;
            temperature = parseFloat(document.getElementById('temperature').value);
            sessionInstructions = document.getElementById('sessionInstructions').value;
            imageModel = document.getElementById('imageModel').value;
            whisperLanguage = document.getElementById('whisperLanguage').value;
            responseLanguage = document.getElementById('responseLanguage').value;
            
            // Save to localStorage
            localStorage.setItem('openai_api_key', apiKey);
            localStorage.setItem('selected_model', selectedModel);
            localStorage.setItem('selected_voice', selectedVoice);
            localStorage.setItem('temperature', temperature);
            localStorage.setItem('session_instructions', sessionInstructions);
            localStorage.setItem('image_model', imageModel);
            localStorage.setItem('whisper_language', whisperLanguage);
            localStorage.setItem('response_language', responseLanguage);
            
            showToast('✅ تم حفظ الإعدادات مع خيارات اللغة الجديدة', 'success');
            closeSettings();
            
            // If connected, update session with new language settings
            if (isConnected && dc && dc.readyState === 'open') {
                const languageMap = {
                    'arabic': 'أنت مساعد ذكي مفيد وودود. أجب باللغة العربية بشكل طبيعي ومختصر وواضح.',
                    'english': 'You are a helpful and friendly AI assistant. Respond in English naturally and concisely.',
                    'mixed': 'أنت مساعد ذكي مفيد وودود. يمكنك الرد بالعربية أو الإنجليزية حسب لغة السؤال.'
                };

                const finalInstructions = sessionInstructions + ' ' + (languageMap[responseLanguage] || languageMap['arabic']);
                
                const updateMessage = {
                    type: "session.update",
                    session: {
                        instructions: finalInstructions,
                        voice: selectedVoice,
                        temperature: temperature,
                        input_audio_transcription: {
                            model: "whisper-1",
                            language: whisperLanguage === 'auto' ? null : whisperLanguage
                        }
                    }
                };
                dc.send(JSON.stringify(updateMessage));
                showToast('🔄 تم تحديث إعدادات الجلسة الحالية', 'info');
            }
        }

        // Auto-save settings on change
        function setupAutoSave() {
            const inputs = ['openaiApiKey', 'model', 'voice', 'temperature', 'sessionInstructions', 'imageModel', 'whisperLanguage', 'responseLanguage'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => {
                        clearTimeout(window.autoSaveTimeout);
                        window.autoSaveTimeout = setTimeout(() => {
                            saveSettings();
                            showToast('💾 تم الحفظ التلقائي', 'info');
                        }, 2000);
                    });
                }
            });
        }

        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
            loadSettingsForm();
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // ========= Image Generation (unchanged) =========
        async function generateImage() {
            const prompt = document.getElementById('imagePrompt').value.trim();
            if (!prompt) {
                showToast('⚠️ اكتب وصف الصورة', 'warning');
                return;
            }
            
            if (!apiKey || apiKey === "Your OPENAI_API_KEY from platform.openai.com") {
                showToast('⚠️ أدخل مفتاح OpenAI API', 'error');
                return;
            }
            
            const button = document.getElementById('generateBtnText');
            button.innerHTML = '<div class="loading"></div> توليد...';
            document.querySelector('.generate-btn').disabled = true;
            
            try {
                const response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: imageModel,
                        prompt: prompt,
                        n: 1,
                        size: imageModel === 'dall-e-3' ? '1024x1024' : '512x512',
                        quality: 'standard'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `DALL-E خطأ: ${response.status}`);
                }
                
                const data = await response.json();
                displayGeneratedImage(data.data[0], prompt);
                showToast('✅ تم توليد الصورة!', 'success');
                
            } catch (error) {
                showToast('❌ خطأ في توليد الصورة: ' + error.message, 'error');
            } finally {
                button.textContent = '🎨 توليد الصورة';
                document.querySelector('.generate-btn').disabled = false;
            }
        }

        function displayGeneratedImage(imageData, prompt) {
            const container = document.getElementById('generatedImages');
            
            const imageCard = document.createElement('div');
            imageCard.className = 'image-card';
            imageCard.innerHTML = `
                <img src="${imageData.url}" alt="${prompt}" onclick="window.open('${imageData.url}', '_blank')" loading="lazy">
                <div class="image-info">
                    <strong>الوصف:</strong> ${prompt}<br>
                    <small>${new Date().toLocaleString('ar')}</small>
                </div>
            `;
            
            container.insertBefore(imageCard, container.firstChild);
        }

        // ========= Image Analysis (unchanged) =========
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            ['dragover', 'dragenter'].forEach(event => {
                uploadArea.addEventListener(event, (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
            });
            
            ['dragleave', 'drop'].forEach(event => {
                uploadArea.addEventListener(event, (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });
            });
            
            uploadArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    analyzeImage(files[0]);
                }
            });
        }

        async function analyzeImage(file) {
            if (!file || !file.type.startsWith('image/')) {
                showToast('⚠️ اختر ملف صورة صحيح', 'warning');
                return;
            }
            
            if (!apiKey || apiKey === "Your OPENAI_API_KEY from platform.openai.com") {
                showToast('⚠️ أدخل مفتاح OpenAI API', 'error');
                return;
            }
            
            const resultsDiv = document.getElementById('analysisResults');
            resultsDiv.innerHTML = '<div style="text-align: center; color: white; padding: 2rem;"><div class="loading"></div><br>جاري تحليل الصورة...</div>';
            
            try {
                const base64 = await compressAndConvertImage(file);
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: 'حلل هذه الصورة بالتفصيل وصفها باللغة العربية. اذكر كل ما تراه في الصورة.'
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: base64,
                                            detail: 'auto'
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.5
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Vision API خطأ: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }
                
                const data = await response.json();
                const analysis = data.choices[0].message.content;
                
                resultsDiv.innerHTML = `
                    <div class="analysis-result">
                        <h4>🔍 تحليل الصورة:</h4>
                        <p style="line-height: 1.6; margin-top: 1rem;">${analysis}</p>
                        <small style="display: block; margin-top: 1rem; color: #666;">تم التحليل: ${new Date().toLocaleString('ar')}</small>
                    </div>
                `;
                
                showToast('✅ تم تحليل الصورة بنجاح!', 'success');
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="analysis-result"><h4>❌ خطأ في التحليل</h4><p>${error.message}</p></div>`;
                showToast('❌ خطأ في تحليل الصورة: ' + error.message, 'error');
            }
        }

        async function compressAndConvertImage(file) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    const maxWidth = 800;
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const base64 = canvas.toDataURL('image/jpeg', 0.8);
                    resolve(base64);
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // ========= Audio Test Function =========
        function testAudio() {
            if ('speechSynthesis' in window) {
                const testText = responseLanguage === 'english' ? 
                    'Audio test - can you hear me?' : 
                    'اختبار الصوت - هل تسمعني؟';
                
                const utterance = new SpeechSynthesisUtterance(testText);
                utterance.lang = responseLanguage === 'english' ? 'en-US' : 'ar-SA';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = volumeSliderEl.value;
                
                utterance.onstart = () => showToast('🔊 اختبار الصوت...', 'info');
                utterance.onend = () => showToast('✅ انتهى اختبار الصوت', 'success');
                utterance.onerror = () => showToast('❌ خطأ في تشغيل الصوت', 'error');
                
                speechSynthesis.speak(utterance);
            } else {
                showToast('❌ المتصفح لا يدعم تشغيل الصوت', 'error');
            }
        }

        // ========= News System (unchanged) =========
        const newsSources = {
            'all': [
                'https://feeds.bbci.co.uk/news/world/rss.xml',
                'https://rss.cnn.com/rss/edition.rss',
                'https://feeds.techcrunch.com/TechCrunch/',
                'https://feeds.reuters.com/reuters/topNews',
                'https://feeds.skynews.com/feeds/rss/world.xml'
            ],
            'bbc': ['https://feeds.bbci.co.uk/news/world/rss.xml'],
            'cnn': ['https://rss.cnn.com/rss/edition.rss'],
            'tech': [
                'https://feeds.techcrunch.com/TechCrunch/',
                'https://feeds.theverge.com/theverge/index.xml',
                'https://feeds.arstechnica.com/arstechnica/index'
            ],
            'sports': [
                'https://feeds.bbci.co.uk/sport/rss.xml',
                'https://rss.espn.com/espn/rss/news'
            ],
            'science': [
                'https://feeds.nature.com/nature/rss/current',
                'https://feeds.sciencedaily.com/sciencedaily/top_news'
            ]
        };

        async function loadNews(source = 'all') {
            setActiveNewsSource(source);
            
            const container = document.getElementById('newsContainer');
            container.innerHTML = '<div class="empty-state"><h3>📰 جاري جلب الأخبار...</h3><p>استخدام طرق متعددة لجلب الأخبار</p></div>';
            
            try {
                const cacheKey = `${source}-${new Date().toDateString()}`;
                
                if (newsCache.has(cacheKey)) {
                    displayNews(newsCache.get(cacheKey));
                    return;
                }
                
                const sources = newsSources[source] || newsSources['all'];
                const allNews = [];
                
                for (const rssUrl of sources) {
                    try {
                        const news = await fetchNewsFromRSS(rssUrl);
                        allNews.push(...news);
                    } catch (error) {
                        console.error(`Failed to fetch ${rssUrl}:`, error);
                    }
                }
                
                // Sort by date
                allNews.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
                
                const uniqueNews = removeDuplicates(allNews);
                newsCache.set(cacheKey, uniqueNews.slice(0, 20));
                displayNews(uniqueNews.slice(0, 20));
                
            } catch (error) {
                console.error('News loading error:', error);
                await loadFallbackNews();
            }
        }

        async function fetchNewsFromRSS(rssUrl) {
            try {
                const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}&count=10`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    return data.items.map(item => ({
                        title: item.title,
                        summary: item.description ? stripHtml(item.description).substring(0, 200) + '...' : 'لا يوجد وصف',
                        source: data.feed?.title || 'مصدر إخباري',
                        time: getTimeAgo(item.pubDate),
                        url: item.link,
                        image: item.enclosure?.link || item.thumbnail || null,
                        pubDate: item.pubDate
                    }));
                }
            } catch (error) {
                console.error('RSS2JSON failed:', error);
            }
            
            return [];
        }

        async function searchNews() {
            const query = document.getElementById('newsQuery').value.trim();
            if (!query) {
                showToast('⚠️ اكتب موضوع للبحث', 'warning');
                return;
            }
            
            const button = document.getElementById('searchBtnText');
            button.innerHTML = '<div class="loading"></div> بحث...';
            document.querySelector('.search-btn').disabled = true;
            
            try {
                const container = document.getElementById('newsContainer');
                container.innerHTML = '<div class="empty-state"><h3>🔍 جاري البحث...</h3><p>البحث في الأخبار المحفوظة</p></div>';
                
                let searchResults = [];
                
                for (const [cacheKey, cachedNews] of newsCache.entries()) {
                    const matchingNews = cachedNews.filter(item => 
                        item.title.toLowerCase().includes(query.toLowerCase()) ||
                        item.summary.toLowerCase().includes(query.toLowerCase())
                    );
                    searchResults.push(...matchingNews);
                }
                
                searchResults = removeDuplicates(searchResults);
                
                if (searchResults.length === 0) {
                    searchResults = [
                        {
                            title: `البحث عن: ${query}`,
                            summary: `نتائج البحث عن موضوع "${query}" - لا توجد نتائج في الأخبار المحفوظة حالياً`,
                            source: "نتائج البحث",
                            time: "الآن",
                            url: "#",
                            image: null,
                            pubDate: new Date().toISOString()
                        }
                    ];
                }
                
                setActiveNewsSource(null);
                displayNews(searchResults);
                showToast(`✅ تم العثور على ${searchResults.length} خبر!`, 'success');
                
            } catch (error) {
                showToast('❌ خطأ في البحث: ' + error.message, 'error');
            } finally {
                button.textContent = '🔍 بحث';
                document.querySelector('.search-btn').disabled = false;
            }
        }

        async function loadFallbackNews() {
            const fallbackNews = [
                {
                    title: "تطورات في تكنولوجيا الذكاء الاصطناعي",
                    summary: "أحدث التطورات في مجال الذكاء الاصطناعي وتأثيرها على المستقبل التكنولوجي...",
                    source: "أخبار التكنولوجيا",
                    time: "منذ ساعة",
                    url: "#",
                    image: null,
                    pubDate: new Date().toISOString()
                },
                {
                    title: "أخبار الرياضة اليوم",
                    summary: "أبرز المباريات والأحداث الرياضية في العالم اليوم...",
                    source: "أخبار الرياضة",
                    time: "منذ ساعتين",
                    url: "#",
                    image: null,
                    pubDate: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString()
                }
            ];
            
            displayNews(fallbackNews);
            showToast('⚠️ تم تحميل أخبار تجريبية', 'warning');
        }

        function removeDuplicates(news) {
            const seen = new Set();
            return news.filter(item => {
                const key = item.title.toLowerCase().trim();
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
        }

        function stripHtml(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        function getTimeAgo(dateString) {
            if (!dateString) return 'غير محدد';
            
            const now = new Date();
            const published = new Date(dateString);
            const diffInHours = Math.floor((now - published) / (1000 * 60 * 60));
            
            if (diffInHours < 1) return 'منذ قليل';
            if (diffInHours < 24) return `منذ ${diffInHours} ساعة`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) return `منذ ${diffInDays} يوم`;
            
            return published.toLocaleDateString('ar');
        }

        function setActiveNewsSource(source) {
            document.querySelectorAll('.source-btn').forEach(btn => btn.classList.remove('active'));
            if (source) {
                const sourceMap = {
                    'all': 0,
                    'bbc': 1,
                    'cnn': 2,
                    'tech': 3,
                    'sports': 4,
                    'science': 5
                };
                const index = sourceMap[source];
                if (index !== undefined) {
                    document.querySelectorAll('.source-btn')[index].classList.add('active');
                }
            }
        }

        function displayNews(articles) {
            const container = document.getElementById('newsContainer');
            
            if (!articles || !articles.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>📰 لا توجد أخبار</h3>
                        <p>جرب البحث عن موضوع آخر أو اختر مصدر مختلف</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = articles.map(article => `
                <div class="news-item" onclick="openNewsArticle('${article.url}', '${article.title}', '${article.summary}')">
                    ${article.image ? `<img src="${article.image}" alt="${article.title}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 1rem;" loading="lazy" onerror="this.style.display='none'">` : ''}
                    <div class="news-title">${article.title}</div>
                    <div class="news-summary">${article.summary}</div>
                    <div class="news-meta">
                        <span class="news-source">${article.source}</span>
                        <span>${article.time}</span>
                    </div>
                    ${article.url && article.url !== '#' ? 
                        '<small style="color: #10B981; font-weight: bold;">📡 مصدر خارجي</small>' : 
                        '<small style="color: #3B82F6; font-weight: bold;">📰 محتوى محلي</small>'}
                </div>
            `).join('');
        }

        function openNewsArticle(url, title, summary) {
            if (url && url !== '#') {
                window.open(url, '_blank');
            } else {
                showToast('📰 ' + title, 'info');
            }
        }

        // ========= Helper Functions =========
        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab:nth-child(${['chat', 'images', 'analysis', 'news'].indexOf(tabName) + 1})`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function showToast(message, type = 'info') {
            document.querySelectorAll('.toast').forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.2s ease-in forwards';
                setTimeout(() => toast.remove(), 200);
            }, 3000);
        }

        // ========= PWA Functions (UPDATED) =========
        function setupPWA() {
            console.log('🚀 بدء تسجيل PWA...');
            
            // تسجيل Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/pixelAi/sw.js', {
                    scope: '/pixelAi/'
                }).then(registration => {
                    console.log('✅ Service Worker registered:', registration.scope);
                    
                    // التحقق من التحديثات
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('🔄 Service Worker جديد متاح');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });
                    
                    // إشعار عند تفعيل Service Worker
                    if (registration.active) {
                        console.log('✅ Service Worker نشط');
                        showToast('🚀 التطبيق جاهز للعمل بدون انترنت!', 'success');
                    }
                    
                }).catch(err => {
                    console.error('❌ Service Worker registration failed:', err);
                    // لا نعرض خطأ للمستخدم لأن PWA اختياري
                });
            }

            // الاستماع لحدث beforeinstallprompt
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('📱 PWA قابل للتثبيت');
                e.preventDefault();
                deferredPrompt = e;
                
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.style.display = 'block';
                }
                
                showToast('📱 يمكنك الآن تثبيت التطبيق!', 'info');
            });

            // إخفاء زر التثبيت إذا كان التطبيق مثبت
            if (window.matchMedia('(display-mode: standalone)').matches) {
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.style.display = 'none';
                }
            }
            
            // الاستماع لحدث التثبيت
            window.addEventListener('appinstalled', (evt) => {
                console.log('🎉 PWA تم تثبيته بنجاح');
                showToast('🎉 تم تثبيت التطبيق بنجاح!', 'success');
                
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.style.display = 'none';
                }
            });
        }

        // دالة تثبيت PWA
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showToast('✅ تم تثبيت التطبيق!', 'success');
                    } else {
                        showToast('💡 يمكنك تثبيت التطبيق لاحقاً', 'info');
                    }
                    deferredPrompt = null;
                    
                    const installBtn = document.getElementById('installBtn');
                    if (installBtn) {
                        installBtn.style.display = 'none';
                    }
                });
            } else {
                showInstallInstructions();
            }
        }

        // إشعار التحديث
        function showUpdateNotification() {
            const updateNotification = document.createElement('div');
            updateNotification.innerHTML = `
                <div style="
                    position: fixed; bottom: 20px; right: 20px; left: 20px;
                    background: linear-gradient(135deg, #4F46E5, #7C3AED);
                    color: white; padding: 1rem; border-radius: 15px;
                    box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
                    z-index: 10000; animation: slideIn 0.3s ease;
                ">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="flex: 1;">
                            <strong>🔄 تحديث متاح!</strong><br>
                            <small>إصدار جديد من التطبيق متاح الآن</small>
                        </div>
                        <button onclick="updateApp()" style="
                            background: white; color: #4F46E5; border: none;
                            padding: 8px 16px; border-radius: 8px; cursor: pointer;
                            font-weight: bold; font-size: 0.9rem;
                        ">تحديث</button>
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: rgba(255,255,255,0.2); color: white; border: none;
                            padding: 8px 16px; border-radius: 8px; cursor: pointer;
                            font-size: 0.9rem;
                        ">لاحقاً</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(updateNotification);
            
            setTimeout(() => {
                if (updateNotification.parentElement) {
                    updateNotification.remove();
                }
            }, 10000);
        }

        // تحديث التطبيق
        async function updateApp() {
            try {
                const registration = await navigator.serviceWorker.getRegistration('/pixelAi/');
                
                if (registration && registration.waiting) {
                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    showToast('🔄 جاري تحديث التطبيق...', 'info');
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    await registration.update();
                    window.location.reload();
                }
            } catch (error) {
                console.error('❌ خطأ في تحديث التطبيق:', error);
                showToast('❌ خطأ في التحديث - سيتم إعادة التحميل', 'error');
                setTimeout(() => window.location.reload(), 2000);
            }
        }

        // تعليمات التثبيت اليدوي
        function showInstallInstructions() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            let instructions = '';
            
            if (isIOS) {
                instructions = `
                    <div style="text-align: right; line-height: 1.6;">
                        <strong>📱 تثبيت التطبيق على iOS:</strong><br>
                        1. اضغط على زر المشاركة في Safari<br>
                        2. اختر "إضافة إلى الشاشة الرئيسية"<br>
                        3. اضغط "إضافة" للتأكيد
                    </div>
                `;
            } else if (isAndroid) {
                instructions = `
                    <div style="text-align: right; line-height: 1.6;">
                        <strong>📱 تثبيت التطبيق على Android:</strong><br>
                        1. اضغط على ⋮ في متصفح Chrome<br>
                        2. اختر "إضافة إلى الشاشة الرئيسية"<br>
                        3. اضغط "إضافة" للتأكيد
                    </div>
                `;
            } else {
                instructions = `
                    <div style="text-align: right; line-height: 1.6;">
                        <strong>💻 تثبيت التطبيق:</strong><br>
                        1. اضغط على أيقونة التثبيت في شريط العناوين<br>
                        2. أو اضغط Ctrl+Shift+A في Chrome<br>
                        3. اختر "تثبيت المساعد الذكي"
                    </div>
                `;
            }
            
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); display: flex; align-items: center;
                    justify-content: center; z-index: 10000; padding: 1rem;
                ">
                    <div style="
                        background: white; border-radius: 15px; padding: 2rem;
                        max-width: 400px; width: 100%; text-align: center;
                    ">
                        <h3 style="margin-bottom: 1rem; color: #333;">📱 تثبيت التطبيق</h3>
                        ${instructions}
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: #4F46E5; color: white; border: none;
                            padding: 10px 20px; border-radius: 10px; cursor: pointer;
                            margin-top: 1rem; font-weight: bold;
                        ">حسناً</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    showToast('❌ لا يمكن فتح الشاشة الكاملة', 'error');
                });
            } else {
                document.exitFullscreen();
            }
        }

        function closeApp() {
            if (confirm('هل تريد إغلاق التطبيق؟')) {
                window.close();
                setTimeout(() => {
                    window.location.href = 'about:blank';
                }, 100);
            }
        }

        // ========= Initialization =========
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            setupDragAndDrop();
            setupPWA();
            setupAutoSave();
            loadNews('all');
            updateConnectionStatus('disconnected');
            
            showToast('🚀 مرحباً بك في المساعد الذكي المحسن!', 'success');
            
            // Click anywhere to enable audio (required by browser policies)
            document.addEventListener('click', () => {
                if (remoteAudioEl.paused) {
                    remoteAudioEl.play().catch(() => {});
                }
            }, { once: true });
            
            // Setup keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.id === 'imagePrompt' && !e.shiftKey) {
                    e.preventDefault();
                    generateImage();
                }
                
                if (e.key === 'Enter' && e.target.id === 'newsQuery') {
                    searchNews();
                }
                
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreen();
                }
            });

            // Auto-load news every 30 minutes
            setInterval(() => {
                if (currentTab === 'news') {
                    loadNews('all');
                }
            }, 30 * 60 * 1000);
        });
    </script>
</body>
</html>
