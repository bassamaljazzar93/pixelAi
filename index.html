<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„ÙÙˆØ±ÙŠ | Real AI Assistant</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ">
    <link rel="manifest" href="/pixelAi/manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
            overflow-x: hidden;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 1.2rem;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 1rem;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Improved Realtime Chat Tab */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 400px;
            max-height: 500px;
        }

        .message {
            display: flex;
            gap: 10px;
            animation: slideIn 0.2s ease-out;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-bubble {
            max-width: 75%;
            padding: 15px 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            line-height: 1.5;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            border-radius: 20px 5px 20px 20px;
        }

        .message.ai .message-bubble {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 5px 20px 20px 20px;
        }

        .message.interim .message-bubble {
            background: rgba(255, 255, 255, 0.7);
            color: #666;
            font-style: italic;
        }

        .message.system .message-bubble {
            background: rgba(59, 130, 246, 0.8);
            color: white;
            font-size: 0.9rem;
            text-align: center;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
        }

        .user .avatar {
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
        }

        .ai .avatar {
            background: rgba(255, 255, 255, 0.9);
        }

        .system .avatar {
            background: rgba(59, 130, 246, 0.8);
        }

        /* Enhanced Realtime Status */
        .realtime-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
        }

        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .connection-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #EF4444;
            transition: all 0.3s ease;
        }

        .connection-dot.connected {
            background: #10B981;
            animation: pulse 2s infinite;
        }

        .connection-dot.connecting {
            background: #F59E0B;
            animation: spin 1s linear infinite;
        }

        /* Audio Controls */
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 0.9rem;
        }

        #volumeSlider {
            width: 80px;
            height: 5px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            -webkit-appearance: none;
        }

        #volumeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }

        #muteButton {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        #muteButton:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Enhanced Controls */
        .controls {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            position: sticky;
            bottom: 0;
        }

        .mic-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.3);
            font-size: 2rem;
        }

        .mic-button:not(.recording):not(.disabled) {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }

        .mic-button.recording {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            animation: recordingPulse 0.8s infinite;
        }

        .mic-button.disabled {
            background: linear-gradient(135deg, #6B7280, #4B5563);
            color: white;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .mic-button:active:not(.disabled) {
            transform: scale(0.95);
        }

        .session-controls {
            display: flex;
            gap: 10px;
        }

        .session-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            color: white;
        }

        .start-session-btn {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .end-session-btn {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }

        .session-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .session-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Everything else stays the same from the original */
        .prompt-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
            resize: vertical;
            min-height: 50px;
        }

        .prompt-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .generate-btn {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
            min-width: 150px;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .generated-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .image-card:hover {
            transform: scale(1.02);
        }

        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
        }

        .image-info {
            padding: 1rem;
            color: white;
            font-size: 0.9rem;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.1);
        }

        .upload-area.dragover {
            border-color: #4F46E5;
            background: rgba(79, 70, 229, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .upload-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }

        .analysis-result {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
            color: #333;
            text-align: right;
            line-height: 1.6;
        }

        .news-search {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .news-search input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
        }

        .news-search input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-btn {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .search-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .search-btn:disabled {
            opacity: 0.6;
        }

        .news-sources {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .source-btn {
            padding: 8px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
        }

        .source-btn.active {
            background: linear-gradient(135deg, #10B981, #059669);
            border-color: transparent;
        }

        .news-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .news-item {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            color: #333;
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 4px solid #4F46E5;
        }

        .news-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .news-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #1f2937;
            line-height: 1.4;
        }

        .news-summary {
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #9ca3af;
            align-items: center;
        }

        .news-source {
            background: #4F46E5;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .settings-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4F46E5;
            background: white;
        }

        .save-btn {
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }

        .empty-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            padding: 2rem;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .hidden {
            display: none !important;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            backdrop-filter: blur(10px);
            animation: slideIn 0.2s ease-out;
            max-width: 300px;
            word-wrap: break-word;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toast.success { background: linear-gradient(135deg, #10B981, #059669); }
        .toast.error { background: linear-gradient(135deg, #EF4444, #DC2626); }
        .toast.warning { background: linear-gradient(135deg, #F59E0B, #D97706); }
        .toast.info { background: linear-gradient(135deg, #3B82F6, #2563EB); }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.04); }
        }

        @keyframes recordingPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0.8rem;
            }
            
            .main-container {
                padding: 0.5rem;
            }
            
            .tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .tab {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .controls {
                padding: 1rem;
                gap: 1rem;
            }
            
            .mic-button {
                width: 70px;
                height: 70px;
                font-size: 1.5rem;
            }
            
            .session-controls {
                flex-direction: column;
                gap: 5px;
            }
            
            .session-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .realtime-status {
                flex-direction: column;
                gap: 10px;
            }
            
            .generated-images {
                grid-template-columns: 1fr;
            }

            .news-search {
                flex-direction: column;
            }

            .search-btn {
                width: 100%;
            }
        }

        .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .install-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
            display: none;
        }

        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>
<body>
    <!-- PWA Install Button -->
    <button class="install-btn" id="installBtn" onclick="installPWA()">ğŸ“± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>

    <!-- Fullscreen Button -->
    <button class="fullscreen-btn" onclick="toggleFullscreen()">â›¶</button>

    <!-- Header -->
    <div class="header">
        <div class="logo">ğŸš€ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„ÙÙˆØ±ÙŠ</div>
        <div class="header-controls">
            <button class="header-btn" onclick="openSettings()" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">âš™ï¸</button>
            <button class="header-btn" onclick="closeApp()" title="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚">âŒ</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('chat')">ğŸ¤ Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙˆØ±ÙŠØ©</div>
            <div class="tab" onclick="switchTab('images')">ğŸ¨ ØµÙˆØ±</div>
            <div class="tab" onclick="switchTab('analysis')">ğŸ” ØªØ­Ù„ÙŠÙ„</div>
            <div class="tab" onclick="switchTab('news')">ğŸ“° Ø£Ø®Ø¨Ø§Ø±</div>
        </div>

        <!-- Realtime Chat Tab -->
        <div class="tab-content active" id="chatTab">
            <div class="realtime-status">
                <div class="connection-indicator">
                    <div class="connection-dot" id="connectionDot"></div>
                    <span id="connectionStatus">ØºÙŠØ± Ù…ØªØµÙ„</span>
                </div>
                <div class="audio-controls">
                    <div class="volume-control">
                        <button id="muteButton">ğŸ”Š</button>
                        <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1">
                        <span>ØµÙˆØª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</span>
                    </div>
                    <button id="testAudioBtn" onclick="testAudio()" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-size: 0.9rem;">ğŸ”Š Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª</button>
                </div>
            </div>
            
            <div class="messages" id="messages">
                <div class="empty-state">
                    <h3>ğŸ¤ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„ÙÙˆØ±ÙŠ</h3>
                    <p>Ø§Ø¨Ø¯Ø£ Ø¬Ù„Ø³Ø© Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙˆØ±ÙŠØ© Ù…Ø¹ GPT-4 Realtime API</p>
                    <small style="color: rgba(255,255,255,0.6); margin-top: 1rem; display: block;">
                        âš¡ WebRTC + Ephemeral Keys Ù„Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø³Ø±Ø¹Ø©
                    </small>
                </div>
            </div>
        </div>

        <!-- Image Generation Tab -->
        <div class="tab-content" id="imagesTab">
            <div class="image-generator">
                <h3 style="color: white; margin-bottom: 1rem; text-align: center;">ğŸ¨ Ù…ÙˆÙ„Ø¯ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø³Ø±ÙŠØ¹</h3>
                <textarea class="prompt-input" id="imagePrompt" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„ØµÙˆØ±Ø©... Ù…Ø«Ø§Ù„: Ù‚Ø·Ø© Ø¬Ù…ÙŠÙ„Ø© ÙÙŠ Ø­Ø¯ÙŠÙ‚Ø©ØŒ Ù†Ù…Ø· ÙƒØ±ØªÙˆÙ†ÙŠ Ù…Ù„ÙˆÙ†" rows="3"></textarea>
                <div style="text-align: center;">
                    <button class="generate-btn" onclick="generateImage()">
                        <span id="generateBtnText">ğŸ¨ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø©</span>
                    </button>
                </div>
                <div class="generated-images" id="generatedImages"></div>
            </div>
        </div>

        <!-- Image Analysis Tab -->
        <div class="tab-content" id="analysisTab">
            <div class="image-analysis">
                <h3 style="color: white; margin-bottom: 1rem; text-align: center;">ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø³Ø±ÙŠØ¹</h3>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ğŸ“¸</div>
                    <div class="upload-text">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø³Ø­Ø¨ ØµÙˆØ±Ø© Ù„ØªØ­Ù„ÙŠÙ„Ù‡Ø§ ÙÙˆØ±Ø§Ù‹</div>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="analyzeImage(this.files[0])">
                <div id="analysisResults"></div>
            </div>
        </div>

        <!-- RSS News Tab -->
        <div class="tab-content" id="newsTab">
            <div class="news-section">
                <h3 style="color: white; margin-bottom: 1rem; text-align: center;">ğŸ“° Ø£Ø®Ø¨Ø§Ø± Ù…Ø­Ø¯Ø«Ø© - 3 ÙŠÙˆÙ„ÙŠÙˆ 2025</h3>
                <p style="color: rgba(255,255,255,0.8); font-size: 0.9rem; text-align: center; margin-bottom: 1rem;">
                    ğŸ”„ ÙŠØ³ØªØ®Ø¯Ù… RSS2JSON + CORS Proxy + Ù…Ø­ØªÙˆÙ‰ Ù…Ø¬Ø§Ù†ÙŠ
                </p>
                
                <!-- Search News -->
                <div class="news-search">
                    <input type="text" id="newsQuery" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±... Ù…Ø«Ø§Ù„: ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ØŒ Ø±ÙŠØ§Ø¶Ø©ØŒ Ø³ÙŠØ§Ø³Ø©">
                    <button class="search-btn" onclick="searchNews()">
                        <span id="searchBtnText">ğŸ” Ø¨Ø­Ø«</span>
                    </button>
                </div>

                <!-- News Sources -->
                <div class="news-sources">
                    <div class="source-btn active" onclick="loadNews('all')">ğŸŒ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±</div>
                    <div class="source-btn" onclick="loadNews('bbc')">ğŸ“º BBC</div>
                    <div class="source-btn" onclick="loadNews('cnn')">ğŸ“¡ CNN</div>
                    <div class="source-btn" onclick="loadNews('tech')">ğŸ’» ØªÙ‚Ù†ÙŠØ©</div>
                    <div class="source-btn" onclick="loadNews('sports')">âš½ Ø±ÙŠØ§Ø¶Ø©</div>
                    <div class="source-btn" onclick="loadNews('science')">ğŸ§¬ Ø¹Ù„ÙˆÙ…</div>
                </div>
                
                <div class="news-container" id="newsContainer">
                    <div class="empty-state">
                        <h3>ğŸ“° Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...</h3>
                        <p>Ø³ÙŠØªÙ… ØªØ¬Ø±Ø¨Ø© Ø·Ø±Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Controls -->
    <div class="controls">
        <div class="session-controls">
            <button class="session-btn start-session-btn" id="startButton" onclick="startSession()">ğŸŸ¢ Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø©</button>
            <button class="session-btn end-session-btn hidden" id="endButton" onclick="endSession()">ğŸ”´ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
        </div>
        <button class="mic-button disabled" id="micButton">ğŸ¤</button>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; color: #333;">
                <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h2>
                <button onclick="closeSettings()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="openaiApiKey">Ù…ÙØªØ§Ø­ OpenAI API (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù€ Realtime API):</label>
                <input type="password" id="openaiApiKey" placeholder="sk-..." value="Your OPENAI_API_KEY from platform.openai.com">
                <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                    âš¡ Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ± ÙˆØªØ­Ù„ÙŠÙ„Ù‡Ø§
                </small>
            </div>
            
            <div class="form-group">
                <label for="model">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:</label>
                <select id="model">
                    <option value="gpt-4o-realtime-preview">GPT-4o Realtime (Ø§Ù„Ø£Ø­Ø¯Ø«)</option>
                    <option value="gpt-4o-mini-realtime-preview">GPT-4o Mini Realtime (Ø³Ø±ÙŠØ¹)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="imageModel">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØµÙˆØ±:</label>
                <select id="imageModel">
                    <option value="dall-e-2">DALL-E 2 (Ø³Ø±ÙŠØ¹)</option>
                    <option value="dall-e-3">DALL-E 3 (Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="voice">Ø§Ù„ØµÙˆØª:</label>
                <select id="voice">
                    <option value="alloy">Alloy (Ù…ØªÙˆØ§Ø²Ù†)</option>
                    <option value="echo">Echo (Ø¹Ù…ÙŠÙ‚)</option>
                    <option value="fable">Fable (Ø¨Ø±ÙŠØ·Ø§Ù†ÙŠ)</option>
                    <option value="onyx">Onyx (Ù‚ÙˆÙŠ)</option>
                    <option value="nova">Nova (Ø¯Ø§ÙØ¦)</option>
                    <option value="shimmer">Shimmer (Ù†Ø§Ø¹Ù…)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="temperature">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©:</label>
                <input type="number" id="temperature" step="0.1" min="0" max="2" value="1.0" style="width: 100px;">
                <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                    Ù…Ù† 0 (Ù…Ø­Ø§ÙØ¸) Ø¥Ù„Ù‰ 2 (Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ)
                </small>
            </div>

            <div class="form-group">
                <label for="whisperLanguage">Ù„ØºØ© Ø§Ù„Ù€ Whisper (Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù…):</label>
                <select id="whisperLanguage">
                    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)</option>
                    <option value="en">Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (English)</option>
                    <option value="auto">ØªÙ„Ù‚Ø§Ø¦ÙŠ (Auto-detect)</option>
                    <option value="es">Ø§Ù„Ø¥Ø³Ø¨Ø§Ù†ÙŠØ© (Spanish)</option>
                    <option value="fr">Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© (French)</option>
                    <option value="de">Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© (German)</option>
                    <option value="it">Ø§Ù„Ø¥ÙŠØ·Ø§Ù„ÙŠØ© (Italian)</option>
                    <option value="pt">Ø§Ù„Ø¨Ø±ØªØºØ§Ù„ÙŠØ© (Portuguese)</option>
                    <option value="ru">Ø§Ù„Ø±ÙˆØ³ÙŠØ© (Russian)</option>
                    <option value="ja">Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ÙŠØ© (Japanese)</option>
                    <option value="ko">Ø§Ù„ÙƒÙˆØ±ÙŠØ© (Korean)</option>
                    <option value="zh">Ø§Ù„ØµÙŠÙ†ÙŠØ© (Chinese)</option>
                </select>
                <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                    ğŸ¤ Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù…
                </small>
            </div>

            <div class="form-group">
                <label for="responseLanguage">Ù„ØºØ© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:</label>
                <select id="responseLanguage">
                    <option value="arabic">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    <option value="english">English</option>
                    <option value="mixed">Ù…Ø®ØªÙ„Ø· (Ø¹Ø±Ø¨ÙŠ/Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="sessionInstructions">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©:</label>
                <textarea id="sessionInstructions" rows="3" style="resize: vertical;">Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù…ÙÙŠØ¯ ÙˆÙˆØ¯ÙˆØ¯. Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆÙ…Ø®ØªØµØ±.</textarea>
            </div>
            
            <button class="save-btn" onclick="saveSettings()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 10px; font-size: 0.9rem; color: #333;">
                <strong>ğŸš€ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</strong><br>
                
                <div style="margin: 0.5rem 0;">
                    <strong>âš¡ WebRTC Ù…Ø­Ø³Ù†:</strong><br>
                    â€¢ Ephemeral Keys Ø¢Ù…Ù†Ø©<br>
                    â€¢ Session Management Ù…ØªÙ‚Ø¯Ù…<br>
                    â€¢ Audio Controls Ù…Ø­Ø³Ù†Ø©<br>
                    â€¢ Error Handling Ø´Ø§Ù…Ù„
                </div>
                
                <div style="margin: 0.5rem 0;">
                    <strong>ğŸ§ ØªØ­ÙƒÙ… Ø§Ù„ØµÙˆØª:</strong><br>
                    â€¢ Volume Control<br>
                    â€¢ Mute/Unmute<br>
                    â€¢ Audio Test Button<br>
                    â€¢ Auto-play Ù„Ù„Ø±Ø¯ÙˆØ¯
                </div>
                
                <div style="margin: 0.5rem 0;">
                    <strong>ğŸ—£ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ©:</strong><br>
                    â€¢ ØªØ­Ø¯ÙŠØ¯ Ù„ØºØ© Whisper Ù„Ù„Ø¯Ù‚Ø©<br>
                    â€¢ Ø§Ø®ØªÙŠØ§Ø± Ù„ØºØ© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©<br>
                    â€¢ Ø¯Ø¹Ù… Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù„ØºØ§Øª<br>
                    â€¢ ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù…
                </div>
                
                <div style="margin: 0.5rem 0;">
                    <strong>ğŸ”§ Ø§Ø³ØªÙƒØ´Ø§Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</strong><br>
                    â€¢ Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ù…Ù„ Ø§Ù„ØµÙˆØªØŒ Ø¬Ø±Ø¨ Ø²Ø± "Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª"<br>
                    â€¢ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ØºØ© Ø§Ù„ØµØ­ÙŠØ­Ø©<br>
                    â€¢ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª<br>
                    â€¢ ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­
                </div>
                
                <div style="margin: 0.5rem 0;">
                    <strong>ğŸ”‘ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙØªØ§Ø­:</strong><br>
                    <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #4F46E5;">platform.openai.com/api-keys</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Remote Audio Element -->
    <audio id="remoteAudio" autoplay></audio>

    <script>
        // ========= Enhanced WebRTC Realtime Implementation =========
        // Global Variables from index.html
        let pc;                      // RTCPeerConnection
        let track;                   // Local audio track
        let dc;                      // Data channel
        const assistantResults = {}; // Track interim/final transcripts
        const userMessages = {};     // Track user messages per item ID

        // Enhanced Global Variables
        let apiKey = '';
        let selectedModel = 'gpt-4o-realtime-preview';
        let selectedVoice = 'alloy';
        let temperature = 1.0;
        let sessionInstructions = 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù…ÙÙŠØ¯ ÙˆÙˆØ¯ÙˆØ¯. Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆÙ…Ø®ØªØµØ±.';
        let imageModel = 'dall-e-2';
        let whisperLanguage = 'ar';
        let responseLanguage = 'arabic';
        let isConnected = false;
        let currentTab = 'chat';
        let newsCache = new Map();
        let deferredPrompt = null;

        // Model & function definitions
        const model = selectedModel;
        const gptFunctions = [
            {
                type: "function",
                name: "end_session",
                description: "the user would like to stop interacting with the Agent",
                parameters: {},
            },
        ];

        // Default values
        const defaultSessionInstructions = "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù…ÙÙŠØ¯ ÙˆÙˆØ¯ÙˆØ¯. Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆÙ…Ø®ØªØµØ±.";
        const defaultTemperature = 1.0;
        const defaultVoice = "alloy";
        const defaultWhisperLanguage = "ar";
        const defaultResponseLanguage = "arabic";

        // ========= DOM Elements =========
        const startButtonEl = document.getElementById('startButton');
        const endButtonEl = document.getElementById('endButton');
        const micButtonEl = document.getElementById('micButton');
        const connectionDotEl = document.getElementById('connectionDot');
        const connectionStatusEl = document.getElementById('connectionStatus');
        const messagesEl = document.getElementById('messages');
        const remoteAudioEl = document.getElementById('remoteAudio');
        const muteButtonEl = document.getElementById('muteButton');
        const volumeSliderEl = document.getElementById('volumeSlider');

        // ========= Enhanced WebRTC Functions (from index.html) =========
        
        /**
         * Send initial session instructions and start message.
         */
        function sessionStartMessages() {
            const languageMap = {
                'arabic': 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù…ÙÙŠØ¯ ÙˆÙˆØ¯ÙˆØ¯. Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆÙ…Ø®ØªØµØ± ÙˆÙˆØ§Ø¶Ø­.',
                'english': 'You are a helpful and friendly AI assistant. Respond in English naturally and concisely.',
                'mixed': 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù…ÙÙŠØ¯ ÙˆÙˆØ¯ÙˆØ¯. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø±Ø¯ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø­Ø³Ø¨ Ù„ØºØ© Ø§Ù„Ø³Ø¤Ø§Ù„.'
            };

            const finalInstructions = sessionInstructions + ' ' + (languageMap[responseLanguage] || languageMap['arabic']);
            const startInstruct = responseLanguage === 'english' ? 
                "Start the conversation with a friendly greeting in English." : 
                "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨ØªØ±Ø­ÙŠØ¨ Ù„Ø·ÙŠÙ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.";

            // Update the session with language settings
            const systemMessage = {
                type: "session.update",
                session: {
                    instructions: finalInstructions,
                    voice: selectedVoice,
                    tools: gptFunctions,
                    tool_choice: "auto",
                    input_audio_transcription: {
                        model: "whisper-1",
                        language: whisperLanguage === 'auto' ? null : whisperLanguage
                    },
                    temperature: temperature,
                    modalities: ["text", "audio"],
                    turn_detection: {
                        type: "server_vad",
                        threshold: 0.5,
                        prefix_padding_ms: 300,
                        silence_duration_ms: 800
                    }
                }
            };
            dc.send(JSON.stringify(systemMessage));

            // Send initial greeting
            const startMessage = {
                type: "response.create",
                response: {
                    modalities: ["text", "audio"],
                    instructions: startInstruct,
                    max_output_tokens: 150
                }
            };
            dc.send(JSON.stringify(startMessage));
            appendOrUpdateLog("ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.", "system");
        }

        /**
         * Handle incoming DataChannel messages from the GPT server.
         */
        function handleMessage(event) {
            const message = JSON.parse(event.data);
            const itemId = message.item_id;

            console.log('Received message:', message.type, message);

            switch (message.type) {
                case "session.created":
                    const expiresAt = new Date(message?.session?.expires_at * 1000);
                    console.log(`Session created and will expire at ${expiresAt}`, message);
                    toggleSessionButtons(true);
                    updateConnectionStatus('connected');
                    showToast('ğŸ”— ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    break;

                case "session.updated":
                    console.log('Session updated:', message.session);
                    showToast('âš™ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©', 'info');
                    break;

                case "input_audio_buffer.speech_started":
                    userMessages[itemId] = {message: ""};
                    appendOrUpdateLog(`ğŸ¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...`, "user", itemId);
                    break;

                case "input_audio_buffer.speech_stopped":
                    console.log('Speech stopped, processing...');
                    break;

                case "conversation.item.input_audio_transcription.completed":
                    const content = message.transcript;
                    if (content && userMessages[itemId]) {
                        userMessages[itemId].message = content;
                        appendOrUpdateLog(`${content}`, "user", itemId);
                        console.log('User transcription:', content);
                    }
                    break;

                case "response.audio_transcript.delta":
                    if (itemId) {
                        assistantResults[itemId] = assistantResults[itemId] || "";
                        assistantResults[itemId] += message.delta;
                        appendOrUpdateLog(`${assistantResults[itemId]}`, "interim", itemId);
                    }
                    break;

                case "response.audio_transcript.done":
                    if (itemId) {
                        assistantResults[itemId] = message.transcript;
                        appendOrUpdateLog(`${message.transcript}`, "ai", itemId);
                        console.log('AI response transcript:', message.transcript);
                    }
                    break;

                case "response.audio.delta":
                    // Audio is streamed through WebRTC automatically
                    console.log('Receiving audio delta...');
                    break;

                case "response.audio.done":
                    console.log('Audio response completed');
                    break;

                case "response.done":
                    console.log('Response completed');
                    break;

                case "response.function_call_arguments.done":
                    const {name} = message;
                    if (name === "end_session") {
                        console.log("Ending session based on user request");
                        endSession();
                    }
                    break;

                case "error":
                    console.error("Server error:", message.error);
                    showToast('âŒ Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…: ' + message.error.message, 'error');
                    break;

                default:
                    console.info(`Unhandled message from server: ${message.type}`, message);
                    break;
            }
        }

        /**
         * Start a new WebRTC session with the OpenAI Realtime API.
         */
        async function startSession() {
            console.log("start_session");
            startButtonEl.disabled = true;
            
            if (!apiKey || apiKey === "Your OPENAI_API_KEY from platform.openai.com") {
                console.error("No OpenAI API Key provided");
                showToast('âš ï¸ Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ OpenAI API ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'warning');
                openSettings();
                toggleSessionButtons(false);
                return;
            }

            updateConnectionStatus('connecting');
            showToast('ğŸ”— Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ OpenAI Realtime API...', 'info');
            
            // Capture the local mic with high quality settings
            let stream;
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 24000,
                        channelCount: 1
                    }
                });
                if (!stream) {
                    throw new Error("Failed to get local stream");
                }
                [track] = stream.getAudioTracks();
                console.log('Microphone access granted:', track.getSettings());
            } catch (err) {
                console.error("Error accessing mic:", err);
                showToast('âŒ ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª.', 'error');
                toggleSessionButtons(false);
                updateConnectionStatus('error');
                return;
            }

            // Start the WebRTC session
            try {
                // Create PeerConnection with STUN servers
                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });

                // Enhanced audio setup
                pc.ontrack = (e) => {
                    console.log('Received remote track:', e.track.kind);
                    if (e.track.kind === 'audio') {
                        remoteAudioEl.srcObject = e.streams[0];
                        remoteAudioEl.autoplay = true;
                        remoteAudioEl.volume = volumeSliderEl.value;
                        
                        // Ensure audio plays
                        remoteAudioEl.play().then(() => {
                            console.log('Remote audio playing successfully');
                            showToast('ğŸ”Š ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        }).catch(err => {
                            console.error('Audio play failed:', err);
                            showToast('âš ï¸ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª', 'warning');
                        });
                    }
                };
                
                // Add the local audio track
                pc.addTrack(track, stream);
                console.log('Added local audio track');

                // Create data channel
                dc = pc.createDataChannel("oai", {
                    ordered: true
                });

                // Send session instructions upon opening the data channel
                dc.addEventListener("open", () => {
                    console.log('Data channel opened');
                    sessionStartMessages();
                });

                // Handle incoming messages from the server
                dc.addEventListener("message", handleMessage);

                // Handle data channel errors
                dc.addEventListener("error", (err) => {
                    console.error('Data channel error:', err);
                    showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                });

                // Handle connection state changes
                pc.addEventListener("connectionstatechange", () => {
                    console.log("Connection state:", pc.connectionState);
                    if (pc.connectionState === 'failed') {
                        updateConnectionStatus('error');
                        showToast('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
                    } else if (pc.connectionState === 'disconnected') {
                        updateConnectionStatus('disconnected');
                        showToast('ğŸ”Œ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'warning');
                    } else if (pc.connectionState === 'connected') {
                        console.log('WebRTC connected successfully!');
                    }
                });

                // Monitor ICE connection state
                pc.addEventListener("iceconnectionstatechange", () => {
                    console.log("ICE connection state:", pc.iceConnectionState);
                });

                // Create and set local description
                await pc.setLocalDescription();
                console.log('Local description set');

                // Send offer to OpenAI Realtime API
                const baseUrl = "https://api.openai.com/v1/realtime";
                const response = await fetch(`${baseUrl}?model=${selectedModel}`, {
                    method: "POST",
                    body: pc.localDescription.sdp,
                    headers: {
                        Authorization: `Bearer ${apiKey}`,
                        "Content-Type": "application/sdp"
                    },
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const answerSdp = await response.text();
                const answer = {type: "answer", sdp: answerSdp};
                await pc.setRemoteDescription(answer);
                console.log('Remote description set');

                // Wait for connection to be established
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error(`Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„. Ø§Ù„Ø­Ø§Ù„Ø©: ${pc.connectionState}`));
                    }, 15000);
                    
                    pc.addEventListener("connectionstatechange", () => {
                        if (pc.connectionState === "connected") {
                            clearTimeout(timeout);
                            console.log("WebRTC Peer connection established!");
                            isConnected = true;
                            resolve();
                        } else if (pc.connectionState === "failed") {
                            clearTimeout(timeout);
                            reject(new Error("ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„"));
                        }
                    });
                });

                showToast('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­! ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†', 'success');

            } catch (err) {
                console.error("Error starting session:", err);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©: ' + err.message, 'error');
                if (pc && pc.connectionState !== "closed") {
                    pc.close();
                }
                toggleSessionButtons(false);
                updateConnectionStatus('error');
            }
        }

        /**
         * End the current session.
         */
        async function endSession(instructions = "ÙˆØ¯Ø§Ø¹Ø§Ù‹! Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ.") {
            console.log("Ending session...");

            if (dc?.readyState === "open") {
                // Send farewell message
                const message = {
                    type: "response.create",
                    response: {
                        modalities: ["text", "audio"],
                        instructions: instructions,
                        max_output_tokens: 50
                    }
                };
                dc.send(JSON.stringify(message));

                // Wait a bit for the farewell then close
                setTimeout(() => {
                    if (pc) {
                        pc.close();
                        console.log("Session ended.");
                        appendOrUpdateLog("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©.", "system");
                        isConnected = false;
                        toggleSessionButtons(false);
                        updateConnectionStatus('disconnected');
                    }
                }, 3000);
            } else {
                if (pc) {
                    pc.close();
                    isConnected = false;
                    toggleSessionButtons(false);
                    updateConnectionStatus('disconnected');
                }
            }

            // Turn off mic
            if (track && track.readyState !== "ended") {
                track.stop();
            }

            endButtonEl.disabled = true;
            showToast('ğŸ‘‹ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©', 'info');
        }

        /**
         * Toggle the session control buttons based on the session state.
         */
        function toggleSessionButtons(isSessionActive) {
            startButtonEl.hidden = isSessionActive;
            endButtonEl.hidden = !isSessionActive;
            startButtonEl.disabled = isSessionActive;
            endButtonEl.disabled = false;
            
            // Update mic button with clearer instructions
            if (isSessionActive) {
                micButtonEl.className = 'mic-button';
                micButtonEl.innerHTML = 'ğŸ¤';
                micButtonEl.title = 'Ù…ØªØµÙ„ - Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†';
                showToast('ğŸ¤ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø¬Ø§Ù‡Ø² - Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØªØ­Ø¯Ø«!', 'info');
            } else {
                micButtonEl.className = 'mic-button disabled';
                micButtonEl.innerHTML = 'ğŸ”Œ';
                micButtonEl.title = 'Ø§Ø¶ØºØ· "Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø©" Ø£ÙˆÙ„Ø§Ù‹';
            }
        }

        /**
         * Update connection status indicator
         */
        function updateConnectionStatus(status) {
            switch (status) {
                case 'connecting':
                    connectionDotEl.className = 'connection-dot connecting';
                    connectionStatusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
                    break;
                case 'connected':
                    connectionDotEl.className = 'connection-dot connected';
                    connectionStatusEl.textContent = 'Ù…ØªØµÙ„ - Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©';
                    break;
                case 'disconnected':
                    connectionDotEl.className = 'connection-dot';
                    connectionStatusEl.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
                    break;
                case 'error':
                    connectionDotEl.className = 'connection-dot';
                    connectionStatusEl.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
                    break;
            }
        }

        /**
         * Insert a new log entry or update an existing one.
         */
        function appendOrUpdateLog(message, type = "ai", messageId = null) {
            const emptyState = messagesEl.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            let messageElement;
            if (messageId && document.getElementById(messageId)) {
                messageElement = document.getElementById(messageId);
                messageElement.querySelector('.message-bubble').textContent = message;
            } else {
                messageElement = document.createElement("div");
                messageElement.className = `message ${type}`;
                if (messageId) messageElement.id = messageId;

                const avatar = type === 'user' ? 'ğŸ‘¤' : type === 'ai' ? 'ğŸ¤–' : type === 'system' ? 'â„¹ï¸' : 'âš¡';
                
                messageElement.innerHTML = `
                    <div class="avatar">${avatar}</div>
                    <div class="message-bubble">${message}</div>
                `;
                
                messagesEl.appendChild(messageElement);
            }
            
            messagesEl.scrollTop = messagesEl.scrollHeight;
            
            // Keep only last 50 messages
            while (messagesEl.children.length > 50) {
                messagesEl.removeChild(messagesEl.firstChild);
            }
        }

        // ========= Audio Controls =========
        
        // Volume controls
        volumeSliderEl.addEventListener('input', (e) => {
            remoteAudioEl.volume = e.target.value;
        });

        // Mute button
        let isMuted = false;
        muteButtonEl.addEventListener('click', () => {
            isMuted = !isMuted;
            remoteAudioEl.muted = isMuted;
            muteButtonEl.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
        });

        // ========= Settings Functions (Enhanced) =========
        
        function loadSettings() {
            // Load from localStorage with defaults
            apiKey = localStorage.getItem('openai_api_key') || 'Your OPENAI_API_KEY from platform.openai.com';
            selectedModel = localStorage.getItem('selected_model') || 'gpt-4o-realtime-preview';
            selectedVoice = localStorage.getItem('selected_voice') || 'alloy';
            temperature = parseFloat(localStorage.getItem('temperature')) || 1.0;
            sessionInstructions = localStorage.getItem('session_instructions') || defaultSessionInstructions;
            imageModel = localStorage.getItem('image_model') || 'dall-e-2';
            whisperLanguage = localStorage.getItem('whisper_language') || 'ar';
            responseLanguage = localStorage.getItem('response_language') || 'arabic';
        }

        function loadSettingsForm() {
            document.getElementById('openaiApiKey').value = apiKey;
            document.getElementById('model').value = selectedModel;
            document.getElementById('voice').value = selectedVoice;
            document.getElementById('temperature').value = temperature;
            document.getElementById('sessionInstructions').value = sessionInstructions;
            document.getElementById('imageModel').value = imageModel;
            document.getElementById('whisperLanguage').value = whisperLanguage;
            document.getElementById('responseLanguage').value = responseLanguage;
        }

        function saveSettings() {
            // Get values from form
            apiKey = document.getElementById('openaiApiKey').value;
            selectedModel = document.getElementById('model').value;
            selectedVoice = document.getElementById('voice').value;
            temperature = parseFloat(document.getElementById('temperature').value);
            sessionInstructions = document.getElementById('sessionInstructions').value;
            imageModel = document.getElementById('imageModel').value;
            whisperLanguage = document.getElementById('whisperLanguage').value;
            responseLanguage = document.getElementById('responseLanguage').value;
            
            // Save to localStorage
            localStorage.setItem('openai_api_key', apiKey);
            localStorage.setItem('selected_model', selectedModel);
            localStorage.setItem('selected_voice', selectedVoice);
            localStorage.setItem('temperature', temperature);
            localStorage.setItem('session_instructions', sessionInstructions);
            localStorage.setItem('image_model', imageModel);
            localStorage.setItem('whisper_language', whisperLanguage);
            localStorage.setItem('response_language', responseLanguage);
            
            showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', 'success');
            closeSettings();
            
            // If connected, update session with new language settings
            if (isConnected && dc && dc.readyState === 'open') {
                const languageMap = {
                    'arabic': 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù…ÙÙŠØ¯ ÙˆÙˆØ¯ÙˆØ¯. Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆÙ…Ø®ØªØµØ± ÙˆÙˆØ§Ø¶Ø­.',
                    'english': 'You are a helpful and friendly AI assistant. Respond in English naturally and concisely.',
                    'mixed': 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù…ÙÙŠØ¯ ÙˆÙˆØ¯ÙˆØ¯. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø±Ø¯ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø­Ø³Ø¨ Ù„ØºØ© Ø§Ù„Ø³Ø¤Ø§Ù„.'
                };

                const finalInstructions = sessionInstructions + ' ' + (languageMap[responseLanguage] || languageMap['arabic']);
                
                const updateMessage = {
                    type: "session.update",
                    session: {
                        instructions: finalInstructions,
                        voice: selectedVoice,
                        temperature: temperature,
                        input_audio_transcription: {
                            model: "whisper-1",
                            language: whisperLanguage === 'auto' ? null : whisperLanguage
                        }
                    }
                };
                dc.send(JSON.stringify(updateMessage));
                showToast('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©', 'info');
            }
        }

        // Auto-save settings on change
        function setupAutoSave() {
            const inputs = ['openaiApiKey', 'model', 'voice', 'temperature', 'sessionInstructions', 'imageModel', 'whisperLanguage', 'responseLanguage'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => {
                        clearTimeout(window.autoSaveTimeout);
                        window.autoSaveTimeout = setTimeout(() => {
                            saveSettings();
                            showToast('ğŸ’¾ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ', 'info');
                        }, 2000);
                    });
                }
            });
        }

        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
            loadSettingsForm();
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // ========= Image Generation (unchanged) =========
        async function generateImage() {
            const prompt = document.getElementById('imagePrompt').value.trim();
            if (!prompt) {
                showToast('âš ï¸ Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„ØµÙˆØ±Ø©', 'warning');
                return;
            }
            
            if (!apiKey || apiKey === "Your OPENAI_API_KEY from platform.openai.com") {
                showToast('âš ï¸ Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ OpenAI API', 'error');
                return;
            }
            
            const button = document.getElementById('generateBtnText');
            button.innerHTML = '<div class="loading"></div> ØªÙˆÙ„ÙŠØ¯...';
            document.querySelector('.generate-btn').disabled = true;
            
            try {
                const response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: imageModel,
                        prompt: prompt,
                        n: 1,
                        size: imageModel === 'dall-e-3' ? '1024x1024' : '512x512',
                        quality: 'standard'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `DALL-E Ø®Ø·Ø£: ${response.status}`);
                }
                
                const data = await response.json();
                displayGeneratedImage(data.data[0], prompt);
                showToast('âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø©!', 'success');
                
            } catch (error) {
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message, 'error');
            } finally {
                button.textContent = 'ğŸ¨ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø©';
                document.querySelector('.generate-btn').disabled = false;
            }
        }

        function displayGeneratedImage(imageData, prompt) {
            const container = document.getElementById('generatedImages');
            
            const imageCard = document.createElement('div');
            imageCard.className = 'image-card';
            imageCard.innerHTML = `
                <img src="${imageData.url}" alt="${prompt}" onclick="window.open('${imageData.url}', '_blank')" loading="lazy">
                <div class="image-info">
                    <strong>Ø§Ù„ÙˆØµÙ:</strong> ${prompt}<br>
                    <small>${new Date().toLocaleString('ar')}</small>
                </div>
            `;
            
            container.insertBefore(imageCard, container.firstChild);
        }

        // ========= Image Analysis (unchanged) =========
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            ['dragover', 'dragenter'].forEach(event => {
                uploadArea.addEventListener(event, (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
            });
            
            ['dragleave', 'drop'].forEach(event => {
                uploadArea.addEventListener(event, (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });
            });
            
            uploadArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    analyzeImage(files[0]);
                }
            });
        }

        async function analyzeImage(file) {
            if (!file || !file.type.startsWith('image/')) {
                showToast('âš ï¸ Ø§Ø®ØªØ± Ù…Ù„Ù ØµÙˆØ±Ø© ØµØ­ÙŠØ­', 'warning');
                return;
            }
            
            if (!apiKey || apiKey === "Your OPENAI_API_KEY from platform.openai.com") {
                showToast('âš ï¸ Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ OpenAI API', 'error');
                return;
            }
            
            const resultsDiv = document.getElementById('analysisResults');
            resultsDiv.innerHTML = '<div style="text-align: center; color: white; padding: 2rem;"><div class="loading"></div><br>Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...</div>';
            
            try {
                const base64 = await compressAndConvertImage(file);
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: 'Ø­Ù„Ù„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„ ÙˆØµÙÙ‡Ø§ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©. Ø§Ø°ÙƒØ± ÙƒÙ„ Ù…Ø§ ØªØ±Ø§Ù‡ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©.'
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: base64,
                                            detail: 'auto'
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.5
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Vision API Ø®Ø·Ø£: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }
                
                const data = await response.json();
                const analysis = data.choices[0].message.content;
                
                resultsDiv.innerHTML = `
                    <div class="analysis-result">
                        <h4>ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©:</h4>
                        <p style="line-height: 1.6; margin-top: 1rem;">${analysis}</p>
                        <small style="display: block; margin-top: 1rem; color: #666;">ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${new Date().toLocaleString('ar')}</small>
                    </div>
                `;
                
                showToast('âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="analysis-result"><h4>âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h4><p>${error.message}</p></div>`;
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message, 'error');
            }
        }

        async function compressAndConvertImage(file) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    const maxWidth = 800;
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const base64 = canvas.toDataURL('image/jpeg', 0.8);
                    resolve(base64);
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // ========= Audio Test Function =========
        function testAudio() {
            if ('speechSynthesis' in window) {
                const testText = responseLanguage === 'english' ? 
                    'Audio test - can you hear me?' : 
                    'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª - Ù‡Ù„ ØªØ³Ù…Ø¹Ù†ÙŠØŸ';
                
                const utterance = new SpeechSynthesisUtterance(testText);
                utterance.lang = responseLanguage === 'english' ? 'en-US' : 'ar-SA';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = volumeSliderEl.value;
                
                utterance.onstart = () => showToast('ğŸ”Š Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª...', 'info');
                utterance.onend = () => showToast('âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª', 'success');
                utterance.onerror = () => showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª', 'error');
                
                speechSynthesis.speak(utterance);
            } else {
                showToast('âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª', 'error');
            }
        }

        // ========= News System (unchanged) =========
        const newsSources = {
            'all': [
                'https://feeds.bbci.co.uk/news/world/rss.xml',
                'https://rss.cnn.com/rss/edition.rss',
                'https://feeds.techcrunch.com/TechCrunch/',
                'https://feeds.reuters.com/reuters/topNews',
                'https://feeds.skynews.com/feeds/rss/world.xml'
            ],
            'bbc': ['https://feeds.bbci.co.uk/news/world/rss.xml'],
            'cnn': ['https://rss.cnn.com/rss/edition.rss'],
            'tech': [
                'https://feeds.techcrunch.com/TechCrunch/',
                'https://feeds.theverge.com/theverge/index.xml',
                'https://feeds.arstechnica.com/arstechnica/index'
            ],
            'sports': [
                'https://feeds.bbci.co.uk/sport/rss.xml',
                'https://rss.espn.com/espn/rss/news'
            ],
            'science': [
                'https://feeds.nature.com/nature/rss/current',
                'https://feeds.sciencedaily.com/sciencedaily/top_news'
            ]
        };

        async function loadNews(source = 'all') {
            setActiveNewsSource(source);
            
            const container = document.getElementById('newsContainer');
            container.innerHTML = '<div class="empty-state"><h3>ğŸ“° Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...</h3><p>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</p></div>';
            
            try {
                const cacheKey = `${source}-${new Date().toDateString()}`;
                
                if (newsCache.has(cacheKey)) {
                    displayNews(newsCache.get(cacheKey));
                    return;
                }
                
                const sources = newsSources[source] || newsSources['all'];
                const allNews = [];
                
                for (const rssUrl of sources) {
                    try {
                        const news = await fetchNewsFromRSS(rssUrl);
                        allNews.push(...news);
                    } catch (error) {
                        console.error(`Failed to fetch ${rssUrl}:`, error);
                    }
                }
                
                // Sort by date
                allNews.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
                
                const uniqueNews = removeDuplicates(allNews);
                newsCache.set(cacheKey, uniqueNews.slice(0, 20));
                displayNews(uniqueNews.slice(0, 20));
                
            } catch (error) {
                console.error('News loading error:', error);
                await loadFallbackNews();
            }
        }

        async function fetchNewsFromRSS(rssUrl) {
            try {
                const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}&count=10`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    return data.items.map(item => ({
                        title: item.title,
                        summary: item.description ? stripHtml(item.description).substring(0, 200) + '...' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ',
                        source: data.feed?.title || 'Ù…ØµØ¯Ø± Ø¥Ø®Ø¨Ø§Ø±ÙŠ',
                        time: getTimeAgo(item.pubDate),
                        url: item.link,
                        image: item.enclosure?.link || item.thumbnail || null,
                        pubDate: item.pubDate
                    }));
                }
            } catch (error) {
                console.error('RSS2JSON failed:', error);
            }
            
            return [];
        }

        async function searchNews() {
            const query = document.getElementById('newsQuery').value.trim();
            if (!query) {
                showToast('âš ï¸ Ø§ÙƒØªØ¨ Ù…ÙˆØ¶ÙˆØ¹ Ù„Ù„Ø¨Ø­Ø«', 'warning');
                return;
            }
            
            const button = document.getElementById('searchBtnText');
            button.innerHTML = '<div class="loading"></div> Ø¨Ø­Ø«...';
            document.querySelector('.search-btn').disabled = true;
            
            try {
                const container = document.getElementById('newsContainer');
                container.innerHTML = '<div class="empty-state"><h3>ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</h3><p>Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</p></div>';
                
                let searchResults = [];
                
                for (const [cacheKey, cachedNews] of newsCache.entries()) {
                    const matchingNews = cachedNews.filter(item => 
                        item.title.toLowerCase().includes(query.toLowerCase()) ||
                        item.summary.toLowerCase().includes(query.toLowerCase())
                    );
                    searchResults.push(...matchingNews);
                }
                
                searchResults = removeDuplicates(searchResults);
                
                if (searchResults.length === 0) {
                    searchResults = [
                        {
                            title: `Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: ${query}`,
                            summary: `Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¶ÙˆØ¹ "${query}" - Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø­Ø§Ù„ÙŠØ§Ù‹`,
                            source: "Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«",
                            time: "Ø§Ù„Ø¢Ù†",
                            url: "#",
                            image: null,
                            pubDate: new Date().toISOString()
                        }
                    ];
                }
                
                setActiveNewsSource(null);
                displayNews(searchResults);
                showToast(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${searchResults.length} Ø®Ø¨Ø±!`, 'success');
                
            } catch (error) {
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ' + error.message, 'error');
            } finally {
                button.textContent = 'ğŸ” Ø¨Ø­Ø«';
                document.querySelector('.search-btn').disabled = false;
            }
        }

        async function loadFallbackNews() {
            const fallbackNews = [
                {
                    title: "ØªØ·ÙˆØ±Ø§Øª ÙÙŠ ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
                    summary: "Ø£Ø­Ø¯Ø« Ø§Ù„ØªØ·ÙˆØ±Ø§Øª ÙÙŠ Ù…Ø¬Ø§Ù„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØªØ£Ø«ÙŠØ±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠ...",
                    source: "Ø£Ø®Ø¨Ø§Ø± Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§",
                    time: "Ù…Ù†Ø° Ø³Ø§Ø¹Ø©",
                    url: "#",
                    image: null,
                    pubDate: new Date().toISOString()
                },
                {
                    title: "Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„ÙŠÙˆÙ…",
                    summary: "Ø£Ø¨Ø±Ø² Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„ÙŠÙˆÙ…...",
                    source: "Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø±ÙŠØ§Ø¶Ø©",
                    time: "Ù…Ù†Ø° Ø³Ø§Ø¹ØªÙŠÙ†",
                    url: "#",
                    image: null,
                    pubDate: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString()
                }
            ];
            
            displayNews(fallbackNews);
            showToast('âš ï¸ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£Ø®Ø¨Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠØ©', 'warning');
        }

        function removeDuplicates(news) {
            const seen = new Set();
            return news.filter(item => {
                const key = item.title.toLowerCase().trim();
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
        }

        function stripHtml(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        function getTimeAgo(dateString) {
            if (!dateString) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            
            const now = new Date();
            const published = new Date(dateString);
            const diffInHours = Math.floor((now - published) / (1000 * 60 * 60));
            
            if (diffInHours < 1) return 'Ù…Ù†Ø° Ù‚Ù„ÙŠÙ„';
            if (diffInHours < 24) return `Ù…Ù†Ø° ${diffInHours} Ø³Ø§Ø¹Ø©`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) return `Ù…Ù†Ø° ${diffInDays} ÙŠÙˆÙ…`;
            
            return published.toLocaleDateString('ar');
        }

        function setActiveNewsSource(source) {
            document.querySelectorAll('.source-btn').forEach(btn => btn.classList.remove('active'));
            if (source) {
                const sourceMap = {
                    'all': 0,
                    'bbc': 1,
                    'cnn': 2,
                    'tech': 3,
                    'sports': 4,
                    'science': 5
                };
                const index = sourceMap[source];
                if (index !== undefined) {
                    document.querySelectorAll('.source-btn')[index].classList.add('active');
                }
            }
        }

        function displayNews(articles) {
            const container = document.getElementById('newsContainer');
            
            if (!articles || !articles.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ“° Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø±</h3>
                        <p>Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¶ÙˆØ¹ Ø¢Ø®Ø± Ø£Ùˆ Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ù…Ø®ØªÙ„Ù</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = articles.map(article => `
                <div class="news-item" onclick="openNewsArticle('${article.url}', '${article.title}', '${article.summary}')">
                    ${article.image ? `<img src="${article.image}" alt="${article.title}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 1rem;" loading="lazy" onerror="this.style.display='none'">` : ''}
                    <div class="news-title">${article.title}</div>
                    <div class="news-summary">${article.summary}</div>
                    <div class="news-meta">
                        <span class="news-source">${article.source}</span>
                        <span>${article.time}</span>
                    </div>
                    ${article.url && article.url !== '#' ? 
                        '<small style="color: #10B981; font-weight: bold;">ğŸ“¡ Ù…ØµØ¯Ø± Ø®Ø§Ø±Ø¬ÙŠ</small>' : 
                        '<small style="color: #3B82F6; font-weight: bold;">ğŸ“° Ù…Ø­ØªÙˆÙ‰ Ù…Ø­Ù„ÙŠ</small>'}
                </div>
            `).join('');
        }

        function openNewsArticle(url, title, summary) {
            if (url && url !== '#') {
                window.open(url, '_blank');
            } else {
                showToast('ğŸ“° ' + title, 'info');
            }
        }

        // ========= Helper Functions =========
        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab:nth-child(${['chat', 'images', 'analysis', 'news'].indexOf(tabName) + 1})`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function showToast(message, type = 'info') {
            document.querySelectorAll('.toast').forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.2s ease-in forwards';
                setTimeout(() => toast.remove(), 200);
            }, 3000);
        }

        // ========= PWA Functions (UPDATED) =========
        function setupPWA() {
            console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ PWA...');
            
            // ØªØ³Ø¬ÙŠÙ„ Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/pixelAi/sw.js', {
                    scope: '/pixelAi/'
                }).then(registration => {
                    console.log('âœ… Service Worker registered:', registration.scope);
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('ğŸ”„ Service Worker Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });
                    
                    // Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Service Worker
                    if (registration.active) {
                        console.log('âœ… Service Worker Ù†Ø´Ø·');
                        showToast('ğŸš€ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ±Ù†Øª!', 'success');
                    }
                    
                }).catch(err => {
                    console.error('âŒ Service Worker registration failed:', err);
                    // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø£Ù† PWA Ø§Ø®ØªÙŠØ§Ø±ÙŠ
                });
            }

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø¯Ø« beforeinstallprompt
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('ğŸ“± PWA Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ«Ø¨ÙŠØª');
                e.preventDefault();
                deferredPrompt = e;
                
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.style.display = 'block';
                }
                
                showToast('ğŸ“± ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚!', 'info');
            });

            // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨Øª
            if (window.matchMedia('(display-mode: standalone)').matches) {
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.style.display = 'none';
                }
            }
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø¯Ø« Ø§Ù„ØªØ«Ø¨ÙŠØª
            window.addEventListener('appinstalled', (evt) => {
                console.log('ğŸ‰ PWA ØªÙ… ØªØ«Ø¨ÙŠØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­');
                showToast('ğŸ‰ ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.style.display = 'none';
                }
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ«Ø¨ÙŠØª PWA
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showToast('âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚!', 'success');
                    } else {
                        showToast('ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø§Ø­Ù‚Ø§Ù‹', 'info');
                    }
                    deferredPrompt = null;
                    
                    const installBtn = document.getElementById('installBtn');
                    if (installBtn) {
                        installBtn.style.display = 'none';
                    }
                });
            } else {
                showInstallInstructions();
            }
        }

        // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
        function showUpdateNotification() {
            const updateNotification = document.createElement('div');
            updateNotification.innerHTML = `
                <div style="
                    position: fixed; bottom: 20px; right: 20px; left: 20px;
                    background: linear-gradient(135deg, #4F46E5, #7C3AED);
                    color: white; padding: 1rem; border-radius: 15px;
                    box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
                    z-index: 10000; animation: slideIn 0.3s ease;
                ">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="flex: 1;">
                            <strong>ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù…ØªØ§Ø­!</strong><br>
                            <small>Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†</small>
                        </div>
                        <button onclick="updateApp()" style="
                            background: white; color: #4F46E5; border: none;
                            padding: 8px 16px; border-radius: 8px; cursor: pointer;
                            font-weight: bold; font-size: 0.9rem;
                        ">ØªØ­Ø¯ÙŠØ«</button>
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: rgba(255,255,255,0.2); color: white; border: none;
                            padding: 8px 16px; border-radius: 8px; cursor: pointer;
                            font-size: 0.9rem;
                        ">Ù„Ø§Ø­Ù‚Ø§Ù‹</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(updateNotification);
            
            setTimeout(() => {
                if (updateNotification.parentElement) {
                    updateNotification.remove();
                }
            }, 10000);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        async function updateApp() {
            try {
                const registration = await navigator.serviceWorker.getRegistration('/pixelAi/');
                
                if (registration && registration.waiting) {
                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    showToast('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...', 'info');
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    await registration.update();
                    window.location.reload();
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« - Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'error');
                setTimeout(() => window.location.reload(), 2000);
            }
        }

        // ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ÙŠØ¯ÙˆÙŠ
        function showInstallInstructions() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            let instructions = '';
            
            if (isIOS) {
                instructions = `
                    <div style="text-align: right; line-height: 1.6;">
                        <strong>ğŸ“± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ iOS:</strong><br>
                        1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Safari<br>
                        2. Ø§Ø®ØªØ± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"<br>
                        3. Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ©" Ù„Ù„ØªØ£ÙƒÙŠØ¯
                    </div>
                `;
            } else if (isAndroid) {
                instructions = `
                    <div style="text-align: right; line-height: 1.6;">
                        <strong>ğŸ“± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Android:</strong><br>
                        1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ â‹® ÙÙŠ Ù…ØªØµÙØ­ Chrome<br>
                        2. Ø§Ø®ØªØ± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"<br>
                        3. Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ©" Ù„Ù„ØªØ£ÙƒÙŠØ¯
                    </div>
                `;
            } else {
                instructions = `
                    <div style="text-align: right; line-height: 1.6;">
                        <strong>ğŸ’» ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:</strong><br>
                        1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†<br>
                        2. Ø£Ùˆ Ø§Ø¶ØºØ· Ctrl+Shift+A ÙÙŠ Chrome<br>
                        3. Ø§Ø®ØªØ± "ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ"
                    </div>
                `;
            }
            
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); display: flex; align-items: center;
                    justify-content: center; z-index: 10000; padding: 1rem;
                ">
                    <div style="
                        background: white; border-radius: 15px; padding: 2rem;
                        max-width: 400px; width: 100%; text-align: center;
                    ">
                        <h3 style="margin-bottom: 1rem; color: #333;">ğŸ“± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
                        ${instructions}
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: #4F46E5; color: white; border: none;
                            padding: 10px 20px; border-radius: 10px; cursor: pointer;
                            margin-top: 1rem; font-weight: bold;
                        ">Ø­Ø³Ù†Ø§Ù‹</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    showToast('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©', 'error');
                });
            } else {
                document.exitFullscreen();
            }
        }

        function closeApp() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ')) {
                window.close();
                setTimeout(() => {
                    window.location.href = 'about:blank';
                }, 100);
            }
        }

        // ========= Initialization =========
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            setupDragAndDrop();
            setupPWA();
            setupAutoSave();
            loadNews('all');
            updateConnectionStatus('disconnected');
            
            showToast('ğŸš€ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø­Ø³Ù†!', 'success');
            
            // Click anywhere to enable audio (required by browser policies)
            document.addEventListener('click', () => {
                if (remoteAudioEl.paused) {
                    remoteAudioEl.play().catch(() => {});
                }
            }, { once: true });
            
            // Setup keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.id === 'imagePrompt' && !e.shiftKey) {
                    e.preventDefault();
                    generateImage();
                }
                
                if (e.key === 'Enter' && e.target.id === 'newsQuery') {
                    searchNews();
                }
                
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreen();
                }
            });

            // Auto-load news every 30 minutes
            setInterval(() => {
                if (currentTab === 'news') {
                    loadNews('all');
                }
            }, 30 * 60 * 1000);
        });
    </script>
</body>
</html>
